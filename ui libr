--[[
    milk.chocolate UI Library v2.5.0
    A Linoria-style UI with multiple themes
    
    Changes in v2.5.0:
    - Complete color picker rewrite with hex/RGB inputs and transparency
    - Redesigned keybind system: | Keybind: [X] | Enable Feature | [Toggle] |
    - Added mode switching for keybinds (Hold/Toggle/Always)
    - Added UI Toggle with keybind support
    - Removed old toggle+keybind combo system
    - Context menu for color picker (copy/paste colors)
]]

local MilkChocolate = {}
MilkChocolate.__index = MilkChocolate

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")

local Player = Players.LocalPlayer
local Mouse = Player:GetMouse()

-- Config folder
local ConfigFolder = "milk"

-- Color clipboard for copy/paste
local ColorClipboard = nil

-- Theme Definitions
local Themes = {
    ["Milk Chocolate"] = {
        Name = "Milk Chocolate",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(139, 90, 43),
        Background = Color3.fromRGB(35, 28, 24),
        BackgroundDark = Color3.fromRGB(28, 22, 18),
        BackgroundLight = Color3.fromRGB(45, 36, 30),
        Accent = Color3.fromRGB(139, 90, 43),
        AccentLight = Color3.fromRGB(180, 130, 80),
        AccentDark = Color3.fromRGB(100, 65, 30),
        AccentGlow = Color3.fromRGB(180, 120, 60),
        PastelMain = Color3.fromRGB(200, 160, 130),
        PastelCream = Color3.fromRGB(255, 250, 245),
        Border = Color3.fromRGB(70, 55, 45),
        BorderHover = Color3.fromRGB(139, 90, 43),
        Text = Color3.fromRGB(255, 250, 245),
        TextDark = Color3.fromRGB(200, 190, 180),
        TextDisabled = Color3.fromRGB(120, 110, 100),
        Glow = Color3.fromRGB(139, 90, 43),
        GlowTransparency = 0.85,
        Toggle = Color3.fromRGB(139, 90, 43),
        ToggleOff = Color3.fromRGB(60, 48, 40),
        Dropdown = Color3.fromRGB(40, 32, 26),
        Notification = Color3.fromRGB(35, 28, 24),
        KeybindActive = Color3.fromRGB(255, 220, 150),
    },
    ["White Chocolate"] = {
        Name = "White Chocolate",
        TitleGlow1 = Color3.fromRGB(60, 50, 40),
        TitleGlow2 = Color3.fromRGB(180, 160, 120),
        Background = Color3.fromRGB(250, 245, 235),
        BackgroundDark = Color3.fromRGB(235, 228, 215),
        BackgroundLight = Color3.fromRGB(255, 252, 248),
        Accent = Color3.fromRGB(180, 155, 110),
        AccentLight = Color3.fromRGB(200, 175, 130),
        AccentDark = Color3.fromRGB(160, 135, 90),
        AccentGlow = Color3.fromRGB(200, 175, 130),
        PastelMain = Color3.fromRGB(140, 120, 90),
        PastelCream = Color3.fromRGB(60, 50, 40),
        Border = Color3.fromRGB(200, 185, 165),
        BorderHover = Color3.fromRGB(160, 135, 90),
        Text = Color3.fromRGB(50, 40, 30),
        TextDark = Color3.fromRGB(90, 80, 65),
        TextDisabled = Color3.fromRGB(150, 140, 125),
        Glow = Color3.fromRGB(180, 155, 110),
        GlowTransparency = 0.9,
        Toggle = Color3.fromRGB(180, 155, 110),
        ToggleOff = Color3.fromRGB(210, 200, 185),
        Dropdown = Color3.fromRGB(240, 233, 220),
        Notification = Color3.fromRGB(250, 245, 235),
        KeybindActive = Color3.fromRGB(120, 160, 80),
    },
    ["Oreo"] = {
        Name = "Oreo",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(80, 80, 90),
        Background = Color3.fromRGB(25, 25, 28),
        BackgroundDark = Color3.fromRGB(18, 18, 20),
        BackgroundLight = Color3.fromRGB(38, 38, 42),
        Accent = Color3.fromRGB(245, 245, 250),
        AccentLight = Color3.fromRGB(255, 255, 255),
        AccentDark = Color3.fromRGB(200, 200, 210),
        AccentGlow = Color3.fromRGB(255, 255, 255),
        PastelMain = Color3.fromRGB(200, 200, 210),
        PastelCream = Color3.fromRGB(255, 255, 255),
        Border = Color3.fromRGB(60, 60, 68),
        BorderHover = Color3.fromRGB(245, 245, 250),
        Text = Color3.fromRGB(255, 255, 255),
        TextDark = Color3.fromRGB(200, 200, 210),
        TextDisabled = Color3.fromRGB(100, 100, 110),
        Glow = Color3.fromRGB(255, 255, 255),
        GlowTransparency = 0.9,
        Toggle = Color3.fromRGB(245, 245, 250),
        ToggleOff = Color3.fromRGB(55, 55, 62),
        Dropdown = Color3.fromRGB(32, 32, 36),
        Notification = Color3.fromRGB(25, 25, 28),
        KeybindActive = Color3.fromRGB(150, 255, 150),
    },
    ["Mint"] = {
        Name = "Mint",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(80, 200, 150),
        Background = Color3.fromRGB(25, 35, 32),
        BackgroundDark = Color3.fromRGB(18, 28, 25),
        BackgroundLight = Color3.fromRGB(38, 50, 45),
        Accent = Color3.fromRGB(80, 200, 150),
        AccentLight = Color3.fromRGB(120, 230, 180),
        AccentDark = Color3.fromRGB(50, 150, 110),
        AccentGlow = Color3.fromRGB(100, 220, 170),
        PastelMain = Color3.fromRGB(150, 220, 190),
        PastelCream = Color3.fromRGB(240, 255, 250),
        Border = Color3.fromRGB(50, 75, 65),
        BorderHover = Color3.fromRGB(80, 200, 150),
        Text = Color3.fromRGB(240, 255, 250),
        TextDark = Color3.fromRGB(180, 210, 200),
        TextDisabled = Color3.fromRGB(90, 120, 110),
        Glow = Color3.fromRGB(80, 200, 150),
        GlowTransparency = 0.85,
        Toggle = Color3.fromRGB(80, 200, 150),
        ToggleOff = Color3.fromRGB(50, 70, 62),
        Dropdown = Color3.fromRGB(32, 45, 40),
        Notification = Color3.fromRGB(25, 35, 32),
        KeybindActive = Color3.fromRGB(150, 255, 200),
    },
    ["Dubai"] = {
        Name = "Dubai",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(212, 175, 55),
        Background = Color3.fromRGB(20, 18, 25),
        BackgroundDark = Color3.fromRGB(15, 13, 18),
        BackgroundLight = Color3.fromRGB(32, 28, 40),
        Accent = Color3.fromRGB(212, 175, 55),
        AccentLight = Color3.fromRGB(245, 210, 90),
        AccentDark = Color3.fromRGB(170, 140, 40),
        AccentGlow = Color3.fromRGB(235, 200, 80),
        PastelMain = Color3.fromRGB(230, 200, 120),
        PastelCream = Color3.fromRGB(255, 250, 235),
        Border = Color3.fromRGB(55, 48, 65),
        BorderHover = Color3.fromRGB(212, 175, 55),
        Text = Color3.fromRGB(255, 250, 240),
        TextDark = Color3.fromRGB(200, 190, 170),
        TextDisabled = Color3.fromRGB(100, 95, 85),
        Glow = Color3.fromRGB(212, 175, 55),
        GlowTransparency = 0.85,
        Toggle = Color3.fromRGB(212, 175, 55),
        ToggleOff = Color3.fromRGB(55, 48, 65),
        Dropdown = Color3.fromRGB(28, 24, 35),
        Notification = Color3.fromRGB(20, 18, 25),
        KeybindActive = Color3.fromRGB(255, 230, 130),
    },
    ["Strawberry"] = {
        Name = "Strawberry",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(220, 80, 100),
        Background = Color3.fromRGB(35, 22, 25),
        BackgroundDark = Color3.fromRGB(28, 18, 20),
        BackgroundLight = Color3.fromRGB(50, 32, 38),
        Accent = Color3.fromRGB(220, 80, 100),
        AccentLight = Color3.fromRGB(250, 120, 140),
        AccentDark = Color3.fromRGB(180, 60, 80),
        AccentGlow = Color3.fromRGB(240, 100, 120),
        PastelMain = Color3.fromRGB(255, 180, 190),
        PastelCream = Color3.fromRGB(255, 245, 248),
        Border = Color3.fromRGB(80, 50, 58),
        BorderHover = Color3.fromRGB(220, 80, 100),
        Text = Color3.fromRGB(255, 248, 250),
        TextDark = Color3.fromRGB(210, 180, 190),
        TextDisabled = Color3.fromRGB(120, 95, 105),
        Glow = Color3.fromRGB(220, 80, 100),
        GlowTransparency = 0.85,
        Toggle = Color3.fromRGB(220, 80, 100),
        ToggleOff = Color3.fromRGB(75, 48, 55),
        Dropdown = Color3.fromRGB(42, 28, 32),
        Notification = Color3.fromRGB(35, 22, 25),
        KeybindActive = Color3.fromRGB(255, 160, 180),
    },
    ["Dark Chocolate"] = {
        Name = "Dark Chocolate",
        TitleGlow1 = Color3.fromRGB(255, 255, 255),
        TitleGlow2 = Color3.fromRGB(100, 65, 45),
        Background = Color3.fromRGB(22, 18, 15),
        BackgroundDark = Color3.fromRGB(15, 12, 10),
        BackgroundLight = Color3.fromRGB(35, 28, 24),
        Accent = Color3.fromRGB(130, 85, 55),
        AccentLight = Color3.fromRGB(170, 120, 85),
        AccentDark = Color3.fromRGB(100, 60, 40),
        AccentGlow = Color3.fromRGB(150, 100, 70),
        PastelMain = Color3.fromRGB(190, 150, 125),
        PastelCream = Color3.fromRGB(240, 230, 220),
        Border = Color3.fromRGB(60, 48, 40),
        BorderHover = Color3.fromRGB(130, 85, 55),
        Text = Color3.fromRGB(240, 230, 220),
        TextDark = Color3.fromRGB(180, 165, 150),
        TextDisabled = Color3.fromRGB(100, 90, 80),
        Glow = Color3.fromRGB(130, 85, 55),
        GlowTransparency = 0.85,
        Toggle = Color3.fromRGB(130, 85, 55),
        ToggleOff = Color3.fromRGB(55, 45, 38),
        Dropdown = Color3.fromRGB(30, 24, 20),
        Notification = Color3.fromRGB(22, 18, 15),
        KeybindActive = Color3.fromRGB(220, 170, 130),
    },
}

-- Current Theme
local CurrentTheme = Themes["Milk Chocolate"]
local Colors = CurrentTheme

-- Utility Functions
local Utility = {}

function Utility.Create(instanceType, properties)
    local instance = Instance.new(instanceType)
    for prop, value in pairs(properties) do
        if prop ~= "Parent" then
            instance[prop] = value
        end
    end
    if properties.Parent then
        instance.Parent = properties.Parent
    end
    return instance
end

function Utility.Tween(instance, properties, duration, style, direction)
    local tween = TweenService:Create(
        instance,
        TweenInfo.new(duration or 0.2, style or Enum.EasingStyle.Quart, direction or Enum.EasingDirection.Out),
        properties
    )
    tween:Play()
    return tween
end

function Utility.CreateStroke(frame, color, thickness, transparency)
    return Utility.Create("UIStroke", {
        Parent = frame,
        Color = color or Colors.Border,
        Thickness = thickness or 1,
        Transparency = transparency or 0,
    })
end

function Utility.CreateGlow(frame, color, size, transparency)
    local glow = Utility.Create("ImageLabel", {
        Name = "Glow",
        Parent = frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Size = UDim2.new(1, size or 30, 1, size or 30),
        ZIndex = frame.ZIndex - 1,
        Image = "rbxassetid://5028857084",
        ImageColor3 = color or Colors.Glow,
        ImageTransparency = transparency or Colors.GlowTransparency,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(24, 24, 276, 276),
    })
    return glow
end

function Utility.Ripple(button)
    local ripple = Utility.Create("Frame", {
        Parent = button,
        BackgroundColor3 = Colors.AccentLight,
        BackgroundTransparency = 0.7,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(1, 0, 1, 0),
        ZIndex = button.ZIndex + 1,
    })
    
    Utility.Tween(ripple, {BackgroundTransparency = 1}, 0.3)
    task.delay(0.3, function()
        ripple:Destroy()
    end)
end

function Utility.GetTextSize(text, font, size)
    return game:GetService("TextService"):GetTextSize(text, size, font, Vector2.new(math.huge, math.huge))
end

function Utility.Round(number, decimalPlaces)
    local mult = 10 ^ (decimalPlaces or 0)
    return math.floor(number * mult + 0.5) / mult
end

function Utility.CleanNumber(value, increment)
    if increment < 1 then
        local decStr = tostring(increment)
        local decimalPlaces = 0
        if decStr:find("%.") then
            decimalPlaces = #decStr:match("%.(%d+)")
        end
        return Utility.Round(value, decimalPlaces)
    else
        return math.floor(value + 0.5)
    end
end

function Utility.GetDarkerColor(color)
    local h, s, v = color:ToHSV()
    return Color3.fromHSV(h, s, math.max(0, v - 0.2))
end

-- Mobile + Desktop Drag Support
function Utility.MakeDraggable(dragElement, targetElement)
    local dragging = false
    local dragStart, startPos
    
    local function startDrag(input)
        dragging = true
        dragStart = input.Position
        startPos = targetElement.Position
    end
    
    local function endDrag()
        dragging = false
    end
    
    local function updateDrag(input)
        if dragging then
            local delta = input.Position - dragStart
            Utility.Tween(targetElement, {
                Position = UDim2.new(
                    startPos.X.Scale,
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale,
                    startPos.Y.Offset + delta.Y
                )
            }, 0.05)
        end
    end
    
    dragElement.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            startDrag(input)
        end
    end)
    
    dragElement.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            endDrag()
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            updateDrag(input)
        end
    end)
end

function Utility.MakeResizable(resizeElement, targetElement, minSize, maxSize)
    local resizing = false
    local resizeStart, startSize
    
    resizeElement.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = true
            resizeStart = input.Position
            startSize = targetElement.Size
        end
    end)
    
    resizeElement.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - resizeStart
            local newWidth = math.clamp(startSize.X.Offset + delta.X, minSize.X, maxSize.X)
            local newHeight = math.clamp(startSize.Y.Offset + delta.Y, minSize.Y, maxSize.Y)
            
            Utility.Tween(targetElement, {
                Size = UDim2.new(0, newWidth, 0, newHeight)
            }, 0.05)
        end
    end)
end

function Utility.SaveData(key, data)
    if writefile then
        local success, err = pcall(function()
            writefile(key, HttpService:JSONEncode(data))
        end)
        return success
    end
    return false
end

function Utility.LoadData(key)
    if isfile and readfile then
        if isfile(key) then
            local success, data = pcall(function()
                return HttpService:JSONDecode(readfile(key))
            end)
            if success then
                return data
            end
        end
    end
    return nil
end

function Utility.EnsureFolder(folderName)
    if isfolder and makefolder then
        if not isfolder(folderName) then
            makefolder(folderName)
        end
        return true
    end
    return false
end

function Utility.GetFiles(folderName)
    if isfolder and listfiles then
        if isfolder(folderName) then
            return listfiles(folderName)
        end
    end
    return {}
end

function Utility.DeleteFile(filePath)
    if isfile and delfile then
        if isfile(filePath) then
            delfile(filePath)
            return true
        end
    end
    return false
end

function Utility.ColorToTable(color)
    return {R = color.R, G = color.G, B = color.B}
end

function Utility.TableToColor(t)
    return Color3.new(t.R, t.G, t.B)
end

function Utility.MouseIsOverFrame(frame)
    local mousePos = UserInputService:GetMouseLocation()
    local framePos = frame.AbsolutePosition
    local frameSize = frame.AbsoluteSize
    
    return mousePos.X >= framePos.X and mousePos.X <= framePos.X + frameSize.X
        and mousePos.Y >= framePos.Y and mousePos.Y <= framePos.Y + frameSize.Y
end

-- Key System
function MilkChocolate.CreateKeySystem(config)
    local keyConfig = config or {}
    local requiredKey = keyConfig.Key or "milk.test"
    
    local savedData = Utility.LoadData("milk_chocolate_keydata.json")
    if savedData and savedData.key == requiredKey and savedData.verified then
        return true
    end
    
    local keyGui = Utility.Create("ScreenGui", {
        Name = "MilkChocolateKey",
        Parent = CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false,
    })
    
    local blur = Utility.Create("Frame", {
        Parent = keyGui,
        BackgroundColor3 = Color3.new(0, 0, 0),
        BackgroundTransparency = 0.5,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, 0),
    })
    
    local mainFrame = Utility.Create("Frame", {
        Parent = keyGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -175, 0.5, -120),
        Size = UDim2.new(0, 350, 0, 240),
        ClipsDescendants = true,
    })
    
    Utility.CreateStroke(mainFrame, Colors.Accent, 1)
    Utility.CreateGlow(mainFrame, Colors.AccentGlow, 40, 0.8)
    
    local titleContainer = Utility.Create("Frame", {
        Parent = mainFrame,
        BackgroundColor3 = Colors.BackgroundDark,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 35),
    })
    
    Utility.Create("Frame", {
        Parent = titleContainer,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -1),
        Size = UDim2.new(1, 0, 0, 1),
    })
    
    Utility.Create("TextLabel", {
        Parent = titleContainer,
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, -50, 0, 0),
        Size = UDim2.new(0, 35, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "milk",
        TextColor3 = Colors.TitleGlow1,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Right,
    })
    
    Utility.Create("TextLabel", {
        Parent = titleContainer,
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, -15, 0, 0),
        Size = UDim2.new(0, 80, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = ".chocolate",
        TextColor3 = Colors.TitleGlow2,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    Utility.Create("TextLabel", {
        Parent = mainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 50),
        Size = UDim2.new(1, 0, 0, 40),
        Font = Enum.Font.GothamBold,
        Text = "[LOCKED]",
        TextColor3 = Colors.Accent,
        TextSize = 32,
    })
    
    Utility.Create("TextLabel", {
        Parent = mainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 95),
        Size = UDim2.new(1, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = "Enter your key to continue",
        TextColor3 = Colors.TextDark,
        TextSize = 12,
    })
    
    local keyInput = Utility.Create("TextBox", {
        Parent = mainFrame,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -125, 0, 125),
        Size = UDim2.new(0, 250, 0, 32),
        Font = Enum.Font.Gotham,
        PlaceholderText = "Enter key here...",
        PlaceholderColor3 = Colors.TextDisabled,
        Text = "",
        TextColor3 = Colors.Text,
        TextSize = 12,
        ClearTextOnFocus = false,
    })
    
    Utility.Create("UIPadding", {
        Parent = keyInput,
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
    })
    
    local inputStroke = Utility.CreateStroke(keyInput, Colors.Border, 1)
    
    keyInput.Focused:Connect(function()
        Utility.Tween(inputStroke, {Color = Colors.Accent}, 0.2)
    end)
    
    keyInput.FocusLost:Connect(function()
        Utility.Tween(inputStroke, {Color = Colors.Border}, 0.2)
    end)
    
    local submitButton = Utility.Create("TextButton", {
        Parent = mainFrame,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -60, 0, 170),
        Size = UDim2.new(0, 120, 0, 30),
        Font = Enum.Font.GothamBold,
        Text = "Submit",
        TextColor3 = Colors.PastelCream,
        TextSize = 12,
        AutoButtonColor = false,
    })
    
    Utility.CreateStroke(submitButton, Colors.AccentDark, 1)
    
    local statusLabel = Utility.Create("TextLabel", {
        Parent = mainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 205),
        Size = UDim2.new(1, 0, 0, 20),
        Font = Enum.Font.Gotham,
        Text = "",
        TextColor3 = Color3.fromRGB(255, 100, 100),
        TextSize = 11,
    })
    
    submitButton.MouseEnter:Connect(function()
        Utility.Tween(submitButton, {BackgroundColor3 = Colors.AccentLight}, 0.15)
    end)
    
    submitButton.MouseLeave:Connect(function()
        Utility.Tween(submitButton, {BackgroundColor3 = Colors.Accent}, 0.15)
    end)
    
    local verified = false
    
    submitButton.MouseButton1Click:Connect(function()
        Utility.Ripple(submitButton)
        
        if keyInput.Text == requiredKey then
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            statusLabel.Text = "Key verified! Loading..."
            
            Utility.SaveData("milk_chocolate_keydata.json", {key = requiredKey, verified = true})
            
            verified = true
            task.wait(1)
            keyGui:Destroy()
        else
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            statusLabel.Text = "Invalid key!"
            
            Utility.Tween(mainFrame, {Position = UDim2.new(0.5, -180, 0.5, -120)}, 0.05)
            task.wait(0.05)
            Utility.Tween(mainFrame, {Position = UDim2.new(0.5, -170, 0.5, -120)}, 0.05)
            task.wait(0.05)
            Utility.Tween(mainFrame, {Position = UDim2.new(0.5, -175, 0.5, -120)}, 0.05)
        end
    end)
    
    while not verified and keyGui.Parent do
        task.wait()
    end
    
    return verified
end

-- Main Library
function MilkChocolate.new(config)
    config = config or {}
    
    if config.KeySystem then
        local passed = MilkChocolate.CreateKeySystem({
            Key = config.Key or "milk.test",
            Title = config.Title
        })
        if not passed then
            return nil
        end
    end
    
    local self = setmetatable({}, MilkChocolate)
    
    self.Title = config.Title or "milk.chocolate"
    self.Size = config.Size or UDim2.new(0, 600, 0, 420)
    self.MinSize = {X = 400, Y = 300}
    self.MaxSize = {X = 900, Y = 700}
    self.Tabs = {}
    self.ActiveTab = nil
    self.Keybinds = {}
    self.KeybindWidgetEntries = {}
    self.KeybindStates = {}
    self.Flags = {}
    self.FlagCallbacks = {}
    self.ToggleKey = config.ToggleKey or Enum.KeyCode.RightShift
    self.Notifications = {}
    self.CurrentTheme = config.Theme or "Milk Chocolate"
    self.ThemeObjects = {}
    self.ConfigName = config.ConfigName or "default"
    self.Visible = true
    self.OpenedFrames = {}
    
    Utility.EnsureFolder(ConfigFolder)
    
    self:SetTheme(self.CurrentTheme)
    
    self:CreateGui()
    self:CreateWatermark()
    self:CreateKeybindWidget()
    self:CreateNotificationContainer()
    self:SetupInput()
    
    return self
end

function MilkChocolate:RegisterThemeObject(object, properties)
    table.insert(self.ThemeObjects, {Object = object, Properties = properties})
end

function MilkChocolate:SetTheme(themeName)
    if Themes[themeName] then
        CurrentTheme = Themes[themeName]
        Colors = CurrentTheme
        self.CurrentTheme = themeName
        
        self:UpdateAllThemeColors()
    end
end

function MilkChocolate:UpdateAllThemeColors()
    for _, entry in ipairs(self.ThemeObjects) do
        if entry.Object and entry.Object.Parent then
            for prop, colorKey in pairs(entry.Properties) do
                if Colors[colorKey] then
                    pcall(function()
                        entry.Object[prop] = Colors[colorKey]
                    end)
                end
            end
        end
    end
    
    if self.MainFrame then self.MainFrame.BackgroundColor3 = Colors.Background end
    if self.MainStroke then self.MainStroke.Color = Colors.Accent end
    if self.MainGlow then
        self.MainGlow.ImageColor3 = Colors.AccentGlow
        self.MainGlow.ImageTransparency = Colors.GlowTransparency
    end
    if self.TitleBar then self.TitleBar.BackgroundColor3 = Colors.BackgroundDark end
    if self.MilkLabel then self.MilkLabel.TextColor3 = Colors.TitleGlow1 end
    if self.ChocolateLabel then self.ChocolateLabel.TextColor3 = Colors.TitleGlow2 end
    if self.TabContainer then self.TabContainer.BackgroundColor3 = Colors.BackgroundDark end
    if self.ContentContainer then self.ContentContainer.BackgroundColor3 = Colors.Background end
    if self.TitleSeparator then self.TitleSeparator.BackgroundColor3 = Colors.Accent end
    if self.TabSeparator then self.TabSeparator.BackgroundColor3 = Colors.Border end
    
    if self.ResizeHandle then
        for _, line in pairs(self.ResizeHandle:GetChildren()) do
            if line:IsA("Frame") then
                line.BackgroundColor3 = Colors.TextDark
            end
        end
    end
    
    if self.Watermark then self.Watermark.BackgroundColor3 = Colors.Background end
    if self.WatermarkStroke then self.WatermarkStroke.Color = Colors.Accent end
    if self.WatermarkGlow then
        self.WatermarkGlow.ImageColor3 = Colors.AccentGlow
        self.WatermarkGlow.ImageTransparency = Colors.GlowTransparency
    end
    if self.WatermarkMilk then self.WatermarkMilk.TextColor3 = Colors.TitleGlow1 end
    if self.WatermarkChocolate then self.WatermarkChocolate.TextColor3 = Colors.TitleGlow2 end
    if self.WatermarkStats then self.WatermarkStats.TextColor3 = Colors.Text end
    
    if self.KeybindWidget then self.KeybindWidget.BackgroundColor3 = Colors.Background end
    if self.KeybindWidgetStroke then self.KeybindWidgetStroke.Color = Colors.Accent end
    if self.KeybindWidgetGlow then
        self.KeybindWidgetGlow.ImageColor3 = Colors.AccentGlow
        self.KeybindWidgetGlow.ImageTransparency = Colors.GlowTransparency
    end
    if self.KeybindSeparator then self.KeybindSeparator.BackgroundColor3 = Colors.Accent end
    if self.KeybindTitleLabel then self.KeybindTitleLabel.TextColor3 = Colors.Text end
    
    for name, entry in pairs(self.KeybindWidgetEntries) do
        if entry.NameLabel then
            local isActive = self.KeybindStates[name] or false
            entry.NameLabel.TextColor3 = isActive and Colors.KeybindActive or Colors.Text
        end
        if entry.KeyLabel then entry.KeyLabel.TextColor3 = Colors.Accent end
        if entry.ModeLabel then entry.ModeLabel.TextColor3 = Colors.TextDark end
    end
    
    for _, tab in ipairs(self.Tabs) do
        if tab.Button then
            tab.Button.BackgroundColor3 = Colors.BackgroundDark
            tab.Button.BackgroundTransparency = 1
            if self.ActiveTab == tab then
                tab.ButtonLabel.TextColor3 = Colors.Accent
                if tab.Underline then
                    tab.Underline.BackgroundColor3 = Colors.Accent
                    tab.Underline.Visible = true
                end
            else
                tab.ButtonLabel.TextColor3 = Colors.TextDark
                if tab.Underline then tab.Underline.Visible = false end
            end
        end
        if tab.Content then tab.Content.ScrollBarImageColor3 = Colors.Accent end
        
        for _, section in ipairs(tab.Sections or {}) do
            if section.Frame then section.Frame.BackgroundColor3 = Colors.BackgroundDark end
            if section.Stroke then section.Stroke.Color = Colors.Border end
            if section.Title then section.Title.TextColor3 = Colors.Text end
            if section.TitleContainer then
                for _, child in pairs(section.TitleContainer:GetChildren()) do
                    if child:IsA("Frame") and child.Name == "Separator" then
                        child.BackgroundColor3 = Colors.Accent
                    end
                end
            end
            if section.SectionGlow then
                section.SectionGlow.ImageColor3 = Colors.AccentGlow
                section.SectionGlow.ImageTransparency = Colors.GlowTransparency + 0.05
            end
        end
    end
end

function MilkChocolate:CreateGui()
    self.ScreenGui = Utility.Create("ScreenGui", {
        Name = "MilkChocolate",
        Parent = CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false,
    })
    
    self.MainFrame = Utility.Create("Frame", {
        Name = "Main",
        Parent = self.ScreenGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, -self.Size.X.Offset/2, 0.5, -self.Size.Y.Offset/2),
        Size = self.Size,
        ClipsDescendants = true,
    })
    
    self.MainStroke = Utility.CreateStroke(self.MainFrame, Colors.Accent, 1)
    self.MainGlow = Utility.CreateGlow(self.MainFrame, Colors.AccentGlow, 50, Colors.GlowTransparency)
    
    self.TitleBar = Utility.Create("Frame", {
        Name = "TitleBar",
        Parent = self.MainFrame,
        BackgroundColor3 = Colors.BackgroundDark,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 32),
    })
    
    self.MilkLabel = Utility.Create("TextLabel", {
        Name = "MilkTitle",
        Parent = self.TitleBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(0, 30, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "milk",
        TextColor3 = Colors.TitleGlow1,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    self.ChocolateLabel = Utility.Create("TextLabel", {
        Name = "ChocolateTitle",
        Parent = self.TitleBar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 40, 0, 0),
        Size = UDim2.new(0, 70, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = ".chocolate",
        TextColor3 = Colors.TitleGlow2,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    -- UI Toggle Button
    self.UIToggleButton = Utility.Create("TextButton", {
        Name = "UIToggle",
        Parent = self.TitleBar,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -70, 0, 6),
        Size = UDim2.new(0, 60, 0, 20),
        Font = Enum.Font.Gotham,
        Text = "Hide",
        TextColor3 = Colors.Text,
        TextSize = 10,
        AutoButtonColor = false,
    })
    
    local uiToggleStroke = Utility.CreateStroke(self.UIToggleButton, Colors.Border, 1)
    
    self.UIToggleButton.MouseEnter:Connect(function()
        Utility.Tween(self.UIToggleButton, {BackgroundColor3 = Colors.Accent}, 0.15)
        Utility.Tween(uiToggleStroke, {Color = Colors.AccentLight}, 0.15)
    end)
    
    self.UIToggleButton.MouseLeave:Connect(function()
        Utility.Tween(self.UIToggleButton, {BackgroundColor3 = Colors.BackgroundLight}, 0.15)
        Utility.Tween(uiToggleStroke, {Color = Colors.Border}, 0.15)
    end)
    
    self.UIToggleButton.MouseButton1Click:Connect(function()
        self:Toggle(false)
    end)
    
    self.TitleSeparator = Utility.Create("Frame", {
        Name = "Separator",
        Parent = self.TitleBar,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -1),
        Size = UDim2.new(1, 0, 0, 1),
    })
    
    self.ResizeHandle = Utility.Create("Frame", {
        Name = "ResizeHandle",
        Parent = self.MainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -16, 1, -16),
        Size = UDim2.new(0, 14, 0, 14),
        ZIndex = 10,
    })
    
    for i = 1, 3 do
        Utility.Create("Frame", {
            Name = "Line" .. i,
            Parent = self.ResizeHandle,
            BackgroundColor3 = Colors.TextDark,
            BorderSizePixel = 0,
            AnchorPoint = Vector2.new(0.5, 0.5),
            Position = UDim2.new(0.5, (i - 2) * 3, 0.5, (i - 2) * 3),
            Size = UDim2.new(0, 8, 0, 1),
            Rotation = -45,
            ZIndex = 10,
        })
    end
    
    Utility.MakeResizable(self.ResizeHandle, self.MainFrame, self.MinSize, self.MaxSize)
    
    self.ResizeHandle.MouseEnter:Connect(function()
        for _, line in pairs(self.ResizeHandle:GetChildren()) do
            if line:IsA("Frame") then
                Utility.Tween(line, {BackgroundColor3 = Colors.Accent}, 0.15)
            end
        end
    end)
    
    self.ResizeHandle.MouseLeave:Connect(function()
        for _, line in pairs(self.ResizeHandle:GetChildren()) do
            if line:IsA("Frame") then
                Utility.Tween(line, {BackgroundColor3 = Colors.TextDark}, 0.15)
            end
        end
    end)
    
    self.TabContainer = Utility.Create("Frame", {
        Name = "TabContainer",
        Parent = self.MainFrame,
        BackgroundColor3 = Colors.BackgroundDark,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 32),
        Size = UDim2.new(1, 0, 0, 28),
    })
    
    self.TabSeparator = Utility.Create("Frame", {
        Name = "Separator",
        Parent = self.TabContainer,
        BackgroundColor3 = Colors.Border,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -1),
        Size = UDim2.new(1, 0, 0, 1),
    })
    
    self.TabList = Utility.Create("Frame", {
        Name = "TabList",
        Parent = self.TabContainer,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 5, 0, 0),
        Size = UDim2.new(1, -10, 1, 0),
    })
    
    Utility.Create("UIListLayout", {
        Parent = self.TabList,
        FillDirection = Enum.FillDirection.Horizontal,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5),
    })
    
    self.ContentContainer = Utility.Create("Frame", {
        Name = "ContentContainer",
        Parent = self.MainFrame,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 60),
        Size = UDim2.new(1, 0, 1, -60),
    })
    
    Utility.MakeDraggable(self.TitleBar, self.MainFrame)
end

function MilkChocolate:CreateWatermark()
    self.Watermark = Utility.Create("Frame", {
        Name = "Watermark",
        Parent = self.ScreenGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -10, 0, 10),
        AnchorPoint = Vector2.new(1, 0),
        Size = UDim2.new(0, 250, 0, 26),
        ClipsDescendants = false,
    })
    
    self.WatermarkStroke = Utility.CreateStroke(self.Watermark, Colors.Accent, 1)
    self.WatermarkGlow = Utility.CreateGlow(self.Watermark, Colors.AccentGlow, 25, Colors.GlowTransparency)
    
    self.WatermarkMilk = Utility.Create("TextLabel", {
        Name = "Milk",
        Parent = self.Watermark,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(0, 25, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "milk",
        TextColor3 = Colors.TitleGlow1,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    self.WatermarkChocolate = Utility.Create("TextLabel", {
        Name = "Chocolate",
        Parent = self.Watermark,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 33, 0, 0),
        Size = UDim2.new(0, 60, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = ".chocolate",
        TextColor3 = Colors.TitleGlow2,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    self.WatermarkStats = Utility.Create("TextLabel", {
        Name = "Stats",
        Parent = self.Watermark,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 98, 0, 0),
        Size = UDim2.new(1, -106, 1, 0),
        Font = Enum.Font.Gotham,
        Text = "| FPS: -- | Ping: -- | --:--:--",
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    Utility.MakeDraggable(self.Watermark, self.Watermark)
    
    local frameCount = 0
    local lastTime = tick()
    
    RunService.Heartbeat:Connect(function()
        frameCount = frameCount + 1
        local now = tick()
        
        if now - lastTime >= 0.5 then
            local fps = math.floor(frameCount / (now - lastTime))
            frameCount = 0
            lastTime = now
            local ping = math.floor(Player:GetNetworkPing() * 1000)
            local time = os.date("%H:%M:%S")
            
            local text = string.format("| FPS: %d | Ping: %dms | %s", fps, ping, time)
            self.WatermarkStats.Text = text
            
            local totalWidth = 98 + Utility.GetTextSize(text, Enum.Font.Gotham, 11).X + 10
            self.Watermark.Size = UDim2.new(0, totalWidth, 0, 26)
        end
    end)
end

function MilkChocolate:CreateKeybindWidget()
    self.KeybindWidget = Utility.Create("Frame", {
        Name = "KeybindWidget",
        Parent = self.ScreenGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -10, 0, 46),
        AnchorPoint = Vector2.new(1, 0),
        Size = UDim2.new(0, 200, 0, 28),
        ClipsDescendants = true,
    })
    
    self.KeybindWidgetStroke = Utility.CreateStroke(self.KeybindWidget, Colors.Accent, 1)
    self.KeybindWidgetGlow = Utility.CreateGlow(self.KeybindWidget, Colors.AccentGlow, 25, Colors.GlowTransparency)
    
    self.KeybindWidgetTitle = Utility.Create("Frame", {
        Name = "TitleArea",
        Parent = self.KeybindWidget,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 20),
    })
    
    self.KeybindTitleLabel = Utility.Create("TextLabel", {
        Name = "Title",
        Parent = self.KeybindWidgetTitle,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.GothamBold,
        Text = "Keybinds",
        TextColor3 = Colors.Text,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    self.KeybindSeparator = Utility.Create("Frame", {
        Name = "Separator",
        Parent = self.KeybindWidget,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 22),
        Size = UDim2.new(1, -16, 0, 1),
    })
    
    Utility.MakeDraggable(self.KeybindWidgetTitle, self.KeybindWidget)
    
    self.KeybindList = Utility.Create("Frame", {
        Name = "KeybindList",
        Parent = self.KeybindWidget,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 26),
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    Utility.Create("UIListLayout", {
        Parent = self.KeybindList,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 2),
    })
    
    Utility.Create("UIPadding", {
        Parent = self.KeybindList,
        PaddingBottom = UDim.new(0, 5),
    })
    
    self:UpdateKeybindWidgetSize()
end

function MilkChocolate:UpdateKeybindWidgetSize()
    local count = 0
    for _, child in pairs(self.KeybindList:GetChildren()) do
        if child:IsA("Frame") then
            count = count + 1
        end
    end
    
    local height = 28 + (count * 18)
    if count == 0 then height = 28 end
    
    Utility.Tween(self.KeybindWidget, {Size = UDim2.new(0, 200, 0, height)}, 0.2)
end

function MilkChocolate:AddKeybindToWidget(name, key, mode)
    if key == Enum.KeyCode.Backspace or key == Enum.KeyCode.Unknown then
        return nil, nil
    end
    
    local keybindFrame = Utility.Create("Frame", {
        Name = name,
        Parent = self.KeybindList,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 16),
    })
    
    local nameLabel = Utility.Create("TextLabel", {
        Name = "Name",
        Parent = keybindFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(0, 80, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
    })
    
    local modeLabel = Utility.Create("TextLabel", {
        Name = "Mode",
        Parent = keybindFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 90, 0, 0),
        Size = UDim2.new(0, 45, 1, 0),
        Font = Enum.Font.Gotham,
        Text = "[" .. (mode or "Hold") .. "]",
        TextColor3 = Colors.TextDark,
        TextSize = 9,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local keyLabel = Utility.Create("TextLabel", {
        Name = "Key",
        Parent = keybindFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -50, 0, 0),
        Size = UDim2.new(0, 42, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "[" .. key.Name .. "]",
        TextColor3 = Colors.Accent,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Right,
    })
    
    self.KeybindWidgetEntries[name] = {
        Frame = keybindFrame,
        NameLabel = nameLabel,
        KeyLabel = keyLabel,
        ModeLabel = modeLabel
    }
    self.KeybindStates[name] = false
    
    self:UpdateKeybindWidgetSize()
    
    return keybindFrame, keyLabel
end

function MilkChocolate:SetKeybindState(name, isActive)
    self.KeybindStates[name] = isActive
    
    local entry = self.KeybindWidgetEntries[name]
    if entry and entry.NameLabel then
        entry.NameLabel.TextColor3 = isActive and Colors.KeybindActive or Colors.Text
    end
end

function MilkChocolate:RemoveKeybindFromWidget(name)
    local entry = self.KeybindWidgetEntries[name]
    if entry and entry.Frame then
        entry.Frame:Destroy()
    end
    self.KeybindWidgetEntries[name] = nil
    self.KeybindStates[name] = nil
    self:UpdateKeybindWidgetSize()
end

function MilkChocolate:UpdateKeybindInWidget(name, key, mode)
    local entry = self.KeybindWidgetEntries[name]
    if entry then
        if entry.KeyLabel then entry.KeyLabel.Text = "[" .. key.Name .. "]" end
        if entry.ModeLabel then entry.ModeLabel.Text = "[" .. mode .. "]" end
    end
end

function MilkChocolate:CreateNotificationContainer()
    self.NotificationContainer = Utility.Create("Frame", {
        Name = "Notifications",
        Parent = self.ScreenGui,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 10),
        AnchorPoint = Vector2.new(0, 0),
        Size = UDim2.new(0, 220, 0, 500),
    })
    
    Utility.Create("UIListLayout", {
        Parent = self.NotificationContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
        VerticalAlignment = Enum.VerticalAlignment.Top,
        Padding = UDim.new(0, 8),
    })
end

function MilkChocolate:Notify(config)
    config = config or {}
    local title = config.Title or "Notification"
    local content = config.Content or ""
    local notifType = config.Type or "Info"
    local duration = config.Duration or 4
    
    local typeColors = {
        Info = Colors.Accent,
        Success = Color3.fromRGB(80, 200, 120),
        Warning = Color3.fromRGB(230, 180, 80),
        Error = Color3.fromRGB(220, 80, 80),
    }
    
    local accentColor = typeColors[notifType] or Colors.Accent
    
    local notification = Utility.Create("Frame", {
        Name = "Notification",
        Parent = self.NotificationContainer,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = true,
    })
    
    Utility.CreateStroke(notification, accentColor, 1)
    Utility.CreateGlow(notification, accentColor, 20, 0.85)
    
    Utility.Create("Frame", {
        Name = "AccentLine",
        Parent = notification,
        BackgroundColor3 = accentColor,
        BorderSizePixel = 0,
        Size = UDim2.new(0, 3, 1, 0),
    })
    
    Utility.Create("TextLabel", {
        Parent = notification,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 12, 0, 8),
        Size = UDim2.new(1, -20, 0, 14),
        Font = Enum.Font.GothamBold,
        Text = title,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local contentLabel = Utility.Create("TextLabel", {
        Parent = notification,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 12, 0, 24),
        Size = UDim2.new(1, -20, 0, 0),
        Font = Enum.Font.Gotham,
        Text = content,
        TextColor3 = Colors.TextDark,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Top,
        TextWrapped = true,
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    local progressBar = Utility.Create("Frame", {
        Name = "Progress",
        Parent = notification,
        BackgroundColor3 = accentColor,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -2),
        Size = UDim2.new(1, 0, 0, 2),
    })
    
    task.wait()
    local height = 38 + contentLabel.AbsoluteSize.Y
    height = math.clamp(height, 50, 120)
    
    Utility.Tween(notification, {Size = UDim2.new(1, 0, 0, height)}, 0.3)
    Utility.Tween(progressBar, {Size = UDim2.new(0, 0, 0, 2)}, duration, Enum.EasingStyle.Linear)
    
    task.delay(duration, function()
        Utility.Tween(notification, {Size = UDim2.new(1, 0, 0, 0)}, 0.3)
        task.wait(0.3)
        notification:Destroy()
    end)
    
    return notification
end

function MilkChocolate:SetupInput()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == self.ToggleKey then
            self:Toggle()
        end
    end)
    
    -- Close opened frames when clicking outside
    UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            for frame, _ in pairs(self.OpenedFrames) do
                if frame and frame.Parent then
                    if not Utility.MouseIsOverFrame(frame) then
                        frame.Visible = false
                        self.OpenedFrames[frame] = nil
                    end
                else
                    self.OpenedFrames[frame] = nil
                end
            end
        end
    end)
end

function MilkChocolate:Toggle(visible)
    if visible ~= nil then
        self.Visible = visible
    else
        self.Visible = not self.Visible
    end
    self.MainFrame.Visible = self.Visible
    
    if self.UIToggleButton then
        self.UIToggleButton.Text = self.Visible and "Hide" or "Show"
    end
end

function MilkChocolate:SetToggleKey(key)
    self.ToggleKey = key
end

function MilkChocolate:Destroy()
    self.ScreenGui:Destroy()
end

-- Config System
function MilkChocolate:SaveConfig(name)
    name = name or self.ConfigName
    local configData = {theme = self.CurrentTheme, flags = {}}
    
    for flag, value in pairs(self.Flags) do
        if typeof(value) == "Color3" then
            configData.flags[flag] = {type = "Color3", value = Utility.ColorToTable(value)}
        elseif typeof(value) == "EnumItem" then
            configData.flags[flag] = {type = "EnumItem", value = tostring(value)}
        elseif type(value) == "table" then
            configData.flags[flag] = {type = "table", value = value}
        else
            configData.flags[flag] = {type = type(value), value = value}
        end
    end
    
    local path = ConfigFolder .. "/" .. name .. ".json"
    local success = Utility.SaveData(path, configData)
    
    if success then
        self:Notify({Title = "Config Saved", Content = "Saved: " .. name, Type = "Success", Duration = 2})
    else
        self:Notify({Title = "Error", Content = "Failed to save config!", Type = "Error", Duration = 2})
    end
    
    return success
end

function MilkChocolate:LoadConfig(name)
    name = name or self.ConfigName
    local path = ConfigFolder .. "/" .. name .. ".json"
    local configData = Utility.LoadData(path)
    
    if not configData then
        self:Notify({Title = "Error", Content = "Config not found: " .. name, Type = "Error", Duration = 2})
        return false
    end
    
    if configData.theme then self:SetTheme(configData.theme) end
    
    for flag, data in pairs(configData.flags) do
        local value
        if data.type == "Color3" then
            value = Utility.TableToColor(data.value)
        elseif data.type == "EnumItem" then
            local enumType, enumValue = data.value:match("Enum%.(%w+)%.(%w+)")
            if enumType and enumValue then
                pcall(function() value = Enum[enumType][enumValue] end)
            end
        elseif data.type == "table" then
            value = data.value
        else
            value = data.value
        end
        
        if value ~= nil then
            self.Flags[flag] = value
            if self.FlagCallbacks[flag] then
                pcall(self.FlagCallbacks[flag], value)
            end
            
            if flag == "ShowWatermark" and self.Watermark then
                self.Watermark.Visible = value
            elseif flag == "ShowKeybinds" and self.KeybindWidget then
                self.KeybindWidget.Visible = value
            end
        end
    end
    
    self.ConfigName = name
    self:Notify({Title = "Config Loaded", Content = "Loaded: " .. name, Type = "Success", Duration = 2})
    
    return true
end

function MilkChocolate:DeleteConfig(name)
    local path = ConfigFolder .. "/" .. name .. ".json"
    local success = Utility.DeleteFile(path)
    if success then
        self:Notify({Title = "Config Deleted", Content = "Deleted: " .. name, Type = "Info", Duration = 2})
    end
    return success
end

function MilkChocolate:GetConfigs()
    local configs = {}
    local files = Utility.GetFiles(ConfigFolder)
    for _, file in pairs(files) do
        local name = file:match("([^/\\]+)%.json$")
        if name then table.insert(configs, name) end
    end
    return configs
end

-- Tab Class
local Tab = {}
Tab.__index = Tab

function MilkChocolate:AddTab(config)
    config = config or {}
    
    local tab = setmetatable({}, Tab)
    tab.Name = config.Name or "Tab"
    tab.Library = self
    tab.Sections = {}
    
    tab.Button = Utility.Create("TextButton", {
        Name = tab.Name,
        Parent = self.TabList,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(0, 0, 1, 0),
        AutomaticSize = Enum.AutomaticSize.X,
        Font = Enum.Font.Gotham,
        Text = "",
        AutoButtonColor = false,
    })
    
    Utility.Create("UIPadding", {
        Parent = tab.Button,
        PaddingLeft = UDim.new(0, 8),
        PaddingRight = UDim.new(0, 8),
    })
    
    tab.ButtonLabel = Utility.Create("TextLabel", {
        Parent = tab.Button,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, -4),
        Position = UDim2.new(0, 0, 0, 0),
        Font = Enum.Font.Gotham,
        Text = tab.Name,
        TextColor3 = Colors.TextDark,
        TextSize = 11,
    })
    
    tab.Underline = Utility.Create("Frame", {
        Name = "Underline",
        Parent = tab.Button,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -2),
        Size = UDim2.new(1, 0, 0, 2),
        Visible = false,
    })
    
    tab.Content = Utility.Create("ScrollingFrame", {
        Name = tab.Name .. "Content",
        Parent = self.ContentContainer,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 5, 0, 5),
        Size = UDim2.new(1, -10, 1, -10),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Colors.Accent,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        Visible = false,
    })
    
    tab.LeftColumn = Utility.Create("Frame", {
        Name = "LeftColumn",
        Parent = tab.Content,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 0),
        Size = UDim2.new(0.5, -3, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    Utility.Create("UIListLayout", {
        Parent = tab.LeftColumn,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 6),
    })
    
    tab.RightColumn = Utility.Create("Frame", {
        Name = "RightColumn",
        Parent = tab.Content,
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 3, 0, 0),
        Size = UDim2.new(0.5, -3, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    Utility.Create("UIListLayout", {
        Parent = tab.RightColumn,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 6),
    })
    
    tab.Button.MouseEnter:Connect(function()
        if self.ActiveTab ~= tab then
            Utility.Tween(tab.ButtonLabel, {TextColor3 = Colors.Accent}, 0.15)
        end
    end)
    
    tab.Button.MouseLeave:Connect(function()
        if self.ActiveTab ~= tab then
            Utility.Tween(tab.ButtonLabel, {TextColor3 = Colors.TextDark}, 0.15)
        end
    end)
    
    tab.Button.MouseButton1Click:Connect(function()
        self:SelectTab(tab)
    end)
    
    table.insert(self.Tabs, tab)
    
    if #self.Tabs == 1 then
        self:SelectTab(tab)
    end
    
    return tab
end

function MilkChocolate:SelectTab(tab)
    if self.ActiveTab then
        self.ActiveTab.ButtonLabel.TextColor3 = Colors.TextDark
        self.ActiveTab.Underline.Visible = false
        self.ActiveTab.Content.Visible = false
    end
    
    self.ActiveTab = tab
    tab.ButtonLabel.TextColor3 = Colors.Accent
    tab.Underline.BackgroundColor3 = Colors.Accent
    tab.Underline.Visible = true
    tab.Content.Visible = true
end

-- Section Class
local Section = {}
Section.__index = Section

function Tab:AddSection(config)
    config = config or {}
    
    local section = setmetatable({}, Section)
    section.Name = config.Name or "Section"
    section.Side = config.Side or "Left"
    section.Tab = self
    
    local parent = section.Side == "Left" and self.LeftColumn or self.RightColumn
    
    section.Frame = Utility.Create("Frame", {
        Name = section.Name,
        Parent = parent,
        BackgroundColor3 = Colors.BackgroundDark,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        ClipsDescendants = false,
    })
    
    section.Stroke = Utility.CreateStroke(section.Frame, Colors.Border, 1)
    section.SectionGlow = Utility.CreateGlow(section.Frame, Colors.AccentGlow, 20, Colors.GlowTransparency + 0.05)
    
    section.TitleContainer = Utility.Create("Frame", {
        Name = "TitleContainer",
        Parent = section.Frame,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 22),
    })
    
    Utility.Create("Frame", {
        Name = "Separator",
        Parent = section.TitleContainer,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 1, -1),
        Size = UDim2.new(1, 0, 0, 1),
    })
    
    section.Title = Utility.Create("TextLabel", {
        Name = "Title",
        Parent = section.TitleContainer,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(1, -16, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = section.Name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    section.Content = Utility.Create("Frame", {
        Name = "Content",
        Parent = section.Frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 22),
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    Utility.Create("UIListLayout", {
        Parent = section.Content,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 4),
    })
    
    Utility.Create("UIPadding", {
        Parent = section.Content,
        PaddingTop = UDim.new(0, 5),
        PaddingBottom = UDim.new(0, 8),
        PaddingLeft = UDim.new(0, 8),
        PaddingRight = UDim.new(0, 8),
    })
    
    section.Frame.MouseEnter:Connect(function()
        Utility.Tween(section.Stroke, {Color = Colors.BorderHover}, 0.2)
        Utility.Tween(section.Title, {TextColor3 = Colors.Accent}, 0.2)
        Utility.Tween(section.SectionGlow, {ImageTransparency = Colors.GlowTransparency - 0.1}, 0.2)
    end)
    
    section.Frame.MouseLeave:Connect(function()
        Utility.Tween(section.Stroke, {Color = Colors.Border}, 0.2)
        Utility.Tween(section.Title, {TextColor3 = Colors.Text}, 0.2)
        Utility.Tween(section.SectionGlow, {ImageTransparency = Colors.GlowTransparency + 0.05}, 0.2)
    end)
    
    table.insert(self.Sections, section)
    return section
end

-- UI Elements

function Section:AddButton(config)
    config = config or {}
    local name = config.Name or "Button"
    local callback = config.Callback or function() end
    
    local button = Utility.Create("TextButton", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 28),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        AutoButtonColor = false,
    })
    
    local stroke = Utility.CreateStroke(button, Colors.Border, 1)
    
    self.Tab.Library:RegisterThemeObject(button, {BackgroundColor3 = "BackgroundLight", TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(stroke, {Color = "Border"})
    
    button.MouseEnter:Connect(function()
        Utility.Tween(button, {BackgroundColor3 = Colors.Accent, TextColor3 = Colors.PastelCream}, 0.15)
        Utility.Tween(stroke, {Color = Colors.AccentLight}, 0.15)
    end)
    
    button.MouseLeave:Connect(function()
        Utility.Tween(button, {BackgroundColor3 = Colors.BackgroundLight, TextColor3 = Colors.Text}, 0.15)
        Utility.Tween(stroke, {Color = Colors.Border}, 0.15)
    end)
    
    button.MouseButton1Click:Connect(function()
        Utility.Ripple(button)
        callback()
    end)
    
    return {
        SetText = function(self, text)
            button.Text = text
        end
    }
end

function Section:AddToggle(config)
    config = config or {}
    local name = config.Name or "Toggle"
    local default = config.Default or false
    local callback = config.Callback or function() end
    local flag = config.Flag
    
    local toggled = default
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 28),
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(1, -40, 1, 0),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
    })
    
    local toggleBox = Utility.Create("Frame", {
        Name = "ToggleBox",
        Parent = container,
        BackgroundColor3 = toggled and Colors.Toggle or Colors.ToggleOff,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -26, 0.5, -8),
        Size = UDim2.new(0, 18, 0, 16),
    })
    
    local toggleStroke = Utility.CreateStroke(toggleBox, Colors.Border, 1)
    
    local checkmark = Utility.Create("TextLabel", {
        Parent = toggleBox,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = toggled and "+" or "",
        TextColor3 = Colors.PastelCream,
        TextSize = 12,
    })
    
    local button = Utility.Create("TextButton", {
        Parent = container,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(toggleStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(checkmark, {TextColor3 = "PastelCream"})
    
    local function updateToggle(skipCallback)
        toggleBox.BackgroundColor3 = toggled and Colors.Toggle or Colors.ToggleOff
        checkmark.Text = toggled and "+" or ""
        
        if not skipCallback then
            callback(toggled)
        end
        
        if flag then
            self.Tab.Library.Flags[flag] = toggled
        end
    end
    
    button.MouseButton1Click:Connect(function()
        toggled = not toggled
        updateToggle()
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(container, {BackgroundColor3 = Color3.fromRGB(
            math.min(Colors.BackgroundLight.R * 255 + 15, 255) / 255,
            math.min(Colors.BackgroundLight.G * 255 + 15, 255) / 255,
            math.min(Colors.BackgroundLight.B * 255 + 15, 255) / 255
        )}, 0.15)
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(container, {BackgroundColor3 = Colors.BackgroundLight}, 0.15)
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        self.Tab.Library.Flags[flag] = toggled
        self.Tab.Library.FlagCallbacks[flag] = function(value)
            toggled = value
            updateToggle(true)
        end
    end
    
    updateToggle(true)
    
    return {
        Set = function(self, value)
            toggled = value
            updateToggle()
        end,
        Get = function()
            return toggled
        end
    }
end

function Section:AddSlider(config)
    config = config or {}
    local name = config.Name or "Slider"
    local min = config.Min or 0
    local max = config.Max or 100
    local default = config.Default or min
    local increment = config.Increment or 1
    local callback = config.Callback or function() end
    local flag = config.Flag
    local suffix = config.Suffix or ""
    
    local value = Utility.CleanNumber(default, increment)
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 40),
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -65, 0, 16),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
    })
    
    local valueLabel = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -60, 0, 2),
        Size = UDim2.new(0, 52, 0, 16),
        Font = Enum.Font.GothamBold,
        Text = tostring(value) .. suffix,
        TextColor3 = Colors.Accent,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Right,
    })
    
    local sliderBg = Utility.Create("Frame", {
        Name = "SliderBg",
        Parent = container,
        BackgroundColor3 = Colors.ToggleOff,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 24),
        Size = UDim2.new(1, -16, 0, 8),
    })
    
    Utility.Create("UICorner", {
        Parent = sliderBg,
        CornerRadius = UDim.new(0, 4),
    })
    
    local sliderFill = Utility.Create("Frame", {
        Name = "Fill",
        Parent = sliderBg,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Size = UDim2.new((value - min) / (max - min), 0, 1, 0),
    })
    
    Utility.Create("UICorner", {
        Parent = sliderFill,
        CornerRadius = UDim.new(0, 4),
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(valueLabel, {TextColor3 = "Accent"})
    self.Tab.Library:RegisterThemeObject(sliderBg, {BackgroundColor3 = "ToggleOff"})
    self.Tab.Library:RegisterThemeObject(sliderFill, {BackgroundColor3 = "Accent"})
    
    local dragging = false
    
    local function updateSlider(input, skipCallback)
        local pos = math.clamp((input.Position.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X, 0, 1)
        sliderFill.Size = UDim2.new(pos, 0, 1, 0)
        
        local rawValue = min + ((max - min) * pos)
        value = Utility.CleanNumber(rawValue, increment)
        value = math.clamp(value, min, max)
        
        valueLabel.Text = tostring(value) .. suffix
        
        if not skipCallback then
            callback(value)
        end
        
        if flag then
            self.Tab.Library.Flags[flag] = value
        end
    end
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            updateSlider(input)
        end
    end)
    
    sliderBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updateSlider(input)
        end
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        self.Tab.Library.Flags[flag] = value
        self.Tab.Library.FlagCallbacks[flag] = function(newValue)
            value = Utility.CleanNumber(newValue, increment)
            value = math.clamp(value, min, max)
            sliderFill.Size = UDim2.new((value - min) / (max - min), 0, 1, 0)
            valueLabel.Text = tostring(value) .. suffix
        end
    end
    
    return {
        Set = function(self, newValue)
            value = Utility.CleanNumber(newValue, increment)
            value = math.clamp(value, min, max)
            sliderFill.Size = UDim2.new((value - min) / (max - min), 0, 1, 0)
            valueLabel.Text = tostring(value) .. suffix
            callback(value)
        end,
        Get = function()
            return value
        end
    }
end

function Section:AddDropdown(config)
    config = config or {}
    local name = config.Name or "Dropdown"
    local options = config.Options or {}
    local default = config.Default
    local callback = config.Callback or function() end
    local flag = config.Flag
    
    local selected = default or (options[1] or "")
    local opened = false
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50),
        ClipsDescendants = true,
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local dropdownButton = Utility.Create("TextButton", {
        Name = "DropdownButton",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 20),
        Size = UDim2.new(1, -16, 0, 24),
        Font = Enum.Font.Gotham,
        Text = "  " .. tostring(selected),
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutoButtonColor = false,
    })
    
    local dropdownStroke = Utility.CreateStroke(dropdownButton, Colors.Border, 1)
    
    local arrow = Utility.Create("TextLabel", {
        Parent = dropdownButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0, 0),
        Size = UDim2.new(0, 20, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "v",
        TextColor3 = Colors.TextDark,
        TextSize = 8,
    })
    
    local optionContainer = Utility.Create("Frame", {
        Name = "Options",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 46),
        Size = UDim2.new(1, -16, 0, 0),
        ClipsDescendants = true,
    })
    
    local optionContainerStroke = Utility.CreateStroke(optionContainer, Colors.Border, 1)
    
    Utility.Create("UIListLayout", {
        Parent = optionContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownButton, {BackgroundColor3 = "Dropdown", TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(arrow, {TextColor3 = "TextDark"})
    self.Tab.Library:RegisterThemeObject(optionContainer, {BackgroundColor3 = "Dropdown"})
    self.Tab.Library:RegisterThemeObject(optionContainerStroke, {Color = "Border"})
    
    local optionButtons = {}
    
    local function createOptions()
        for _, child in pairs(optionContainer:GetChildren()) do
            if child:IsA("TextButton") then child:Destroy() end
        end
        optionButtons = {}
        
        for _, option in pairs(options) do
            local optionButton = Utility.Create("TextButton", {
                Parent = optionContainer,
                BackgroundColor3 = Colors.Dropdown,
                BorderSizePixel = 0,
                Size = UDim2.new(1, 0, 0, 24),
                Font = Enum.Font.Gotham,
                Text = "  " .. tostring(option),
                TextColor3 = option == selected and Colors.Accent or Colors.Text,
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Left,
                AutoButtonColor = false,
            })
            
            table.insert(optionButtons, optionButton)
            self.Tab.Library:RegisterThemeObject(optionButton, {BackgroundColor3 = "Dropdown"})
            
            optionButton.MouseEnter:Connect(function()
                Utility.Tween(optionButton, {BackgroundColor3 = Colors.Accent, TextColor3 = Colors.PastelCream}, 0.1)
            end)
            
            optionButton.MouseLeave:Connect(function()
                Utility.Tween(optionButton, {BackgroundColor3 = Colors.Dropdown, TextColor3 = optionButton.Text == "  " .. tostring(selected) and Colors.Accent or Colors.Text}, 0.1)
            end)
            
            optionButton.MouseButton1Click:Connect(function()
                selected = option
                dropdownButton.Text = "  " .. tostring(selected)
                callback(selected)
                
                if flag then self.Tab.Library.Flags[flag] = selected end
                
                for _, btn in pairs(optionButtons) do
                    btn.TextColor3 = btn.Text == "  " .. tostring(selected) and Colors.Accent or Colors.Text
                end
                
                opened = false
                Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50)}, 0.2)
                Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, 0)}, 0.2)
                Utility.Tween(arrow, {Rotation = 0}, 0.2)
            end)
        end
    end
    
    createOptions()
    
    local function toggleDropdown()
        opened = not opened
        local optionHeight = #options * 24
        
        if opened then
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50 + optionHeight + 4)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, optionHeight)}, 0.2)
            Utility.Tween(arrow, {Rotation = 180}, 0.2)
        else
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, 0)}, 0.2)
            Utility.Tween(arrow, {Rotation = 0}, 0.2)
        end
    end
    
    dropdownButton.MouseButton1Click:Connect(toggleDropdown)
    
    dropdownButton.MouseEnter:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Accent}, 0.15)
    end)
    
    dropdownButton.MouseLeave:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Border}, 0.15)
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        self.Tab.Library.Flags[flag] = selected
        self.Tab.Library.FlagCallbacks[flag] = function(value)
            selected = value
            dropdownButton.Text = "  " .. tostring(selected)
            for _, btn in pairs(optionButtons) do
                btn.TextColor3 = btn.Text == "  " .. tostring(selected) and Colors.Accent or Colors.Text
            end
        end
    end
    
    return {
        Set = function(self, value)
            selected = value
            dropdownButton.Text = "  " .. tostring(selected)
            for _, btn in pairs(optionButtons) do
                btn.TextColor3 = btn.Text == "  " .. tostring(selected) and Colors.Accent or Colors.Text
            end
            callback(selected)
        end,
        Get = function()
            return selected
        end,
        Refresh = function(self, newOptions)
            options = newOptions
            createOptions()
        end
    }
end

function Section:AddMultiDropdown(config)
    config = config or {}
    local name = config.Name or "Multi Dropdown"
    local options = config.Options or {}
    local default = config.Default or {}
    local callback = config.Callback or function() end
    local flag = config.Flag
    
    local selected = {}
    for _, v in pairs(default) do selected[v] = true end
    local opened = false
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50),
        ClipsDescendants = true,
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local function getSelectedText()
        local selectedList = {}
        for option, isSelected in pairs(selected) do
            if isSelected then table.insert(selectedList, option) end
        end
        if #selectedList == 0 then return "None"
        elseif #selectedList > 2 then return #selectedList .. " selected"
        else return table.concat(selectedList, ", ") end
    end
    
    local dropdownButton = Utility.Create("TextButton", {
        Name = "DropdownButton",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 20),
        Size = UDim2.new(1, -16, 0, 24),
        Font = Enum.Font.Gotham,
        Text = "  " .. getSelectedText(),
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutoButtonColor = false,
    })
    
    local dropdownStroke = Utility.CreateStroke(dropdownButton, Colors.Border, 1)
    
    local arrow = Utility.Create("TextLabel", {
        Parent = dropdownButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0, 0),
        Size = UDim2.new(0, 20, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "v",
        TextColor3 = Colors.TextDark,
        TextSize = 8,
    })
    
    local optionContainer = Utility.Create("Frame", {
        Name = "Options",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 46),
        Size = UDim2.new(1, -16, 0, 0),
        ClipsDescendants = true,
    })
    
    local optionContainerStroke = Utility.CreateStroke(optionContainer, Colors.Border, 1)
    
    Utility.Create("UIListLayout", {
        Parent = optionContainer,
        SortOrder = Enum.SortOrder.LayoutOrder,
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownButton, {BackgroundColor3 = "Dropdown", TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(arrow, {TextColor3 = "TextDark"})
    self.Tab.Library:RegisterThemeObject(optionContainer, {BackgroundColor3 = "Dropdown"})
    self.Tab.Library:RegisterThemeObject(optionContainerStroke, {Color = "Border"})
    
    local function updateButton()
        dropdownButton.Text = "  " .. getSelectedText()
        local selectedList = {}
        for option, isSelected in pairs(selected) do
            if isSelected then table.insert(selectedList, option) end
        end
        callback(selectedList)
        if flag then self.Tab.Library.Flags[flag] = selectedList end
    end
    
    for _, option in pairs(options) do
        local optionButton = Utility.Create("TextButton", {
            Parent = optionContainer,
            BackgroundColor3 = Colors.Dropdown,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, 24),
            Font = Enum.Font.Gotham,
            Text = "",
            AutoButtonColor = false,
        })
        
        local checkbox = Utility.Create("Frame", {
            Parent = optionButton,
            BackgroundColor3 = selected[option] and Colors.Toggle or Colors.ToggleOff,
            BorderSizePixel = 0,
            Position = UDim2.new(0, 6, 0.5, -6),
            Size = UDim2.new(0, 12, 0, 12),
        })
        
        Utility.CreateStroke(checkbox, Colors.Border, 1)
        
        local checkmark = Utility.Create("TextLabel", {
            Parent = checkbox,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = Enum.Font.GothamBold,
            Text = selected[option] and "+" or "",
            TextColor3 = Colors.PastelCream,
            TextSize = 10,
        })
        
        local optionLabel = Utility.Create("TextLabel", {
            Parent = optionButton,
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 24, 0, 0),
            Size = UDim2.new(1, -30, 1, 0),
            Font = Enum.Font.Gotham,
            Text = tostring(option),
            TextColor3 = Colors.Text,
            TextSize = 11,
            TextXAlignment = Enum.TextXAlignment.Left,
        })
        
        self.Tab.Library:RegisterThemeObject(optionButton, {BackgroundColor3 = "Dropdown"})
        self.Tab.Library:RegisterThemeObject(optionLabel, {TextColor3 = "Text"})
        
        optionButton.MouseEnter:Connect(function()
            Utility.Tween(optionButton, {BackgroundColor3 = Colors.Accent}, 0.1)
        end)
        
        optionButton.MouseLeave:Connect(function()
            Utility.Tween(optionButton, {BackgroundColor3 = Colors.Dropdown}, 0.1)
        end)
        
        optionButton.MouseButton1Click:Connect(function()
            selected[option] = not selected[option]
            checkbox.BackgroundColor3 = selected[option] and Colors.Toggle or Colors.ToggleOff
            checkmark.Text = selected[option] and "+" or ""
            updateButton()
        end)
    end
    
    local function toggleDropdown()
        opened = not opened
        local optionHeight = #options * 24
        
        if opened then
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50 + optionHeight + 4)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, optionHeight)}, 0.2)
            Utility.Tween(arrow, {Rotation = 180}, 0.2)
        else
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, 0)}, 0.2)
            Utility.Tween(arrow, {Rotation = 0}, 0.2)
        end
    end
    
    dropdownButton.MouseButton1Click:Connect(toggleDropdown)
    
    dropdownButton.MouseEnter:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Accent}, 0.15)
    end)
    
    dropdownButton.MouseLeave:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Border}, 0.15)
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        local selectedList = {}
        for option, isSelected in pairs(selected) do
            if isSelected then table.insert(selectedList, option) end
        end
        self.Tab.Library.Flags[flag] = selectedList
    end
    
    return {
        Set = function(self, values)
            selected = {}
            for _, v in pairs(values) do selected[v] = true end
            updateButton()
        end,
        Get = function()
            local result = {}
            for option, isSelected in pairs(selected) do
                if isSelected then table.insert(result, option) end
            end
            return result
        end
    }
end

-- NEW: Redesigned Keybind System
-- Format: | Keybind: [X] | Enable Feature | [Toggle] |
function Section:AddKeybind(config)
    config = config or {}
    local name = config.Name or "Keybind"
    local default = config.Default or Enum.KeyCode.Unknown
    local callback = config.Callback or function() end
    local flag = config.Flag
    local showWidget = config.ShowWidget ~= false
    local mode = config.Mode or "Hold" -- Hold, Toggle, Always
    
    local currentKey = default
    local listening = false
    local isActive = mode == "Always"
    local enabled = true
    
    local modes = {"Hold", "Toggle", "Always"}
    local modeIndex = table.find(modes, mode) or 1
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 28),
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    -- Keybind button (left side)
    local keybindButton = Utility.Create("TextButton", {
        Name = "KeybindButton",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0.5, -10),
        Size = UDim2.new(0, 40, 0, 20),
        Font = Enum.Font.GothamBold,
        Text = currentKey == Enum.KeyCode.Unknown and "None" or currentKey.Name,
        TextColor3 = Colors.Accent,
        TextSize = 9,
        AutoButtonColor = false,
    })
    
    local keybindStroke = Utility.CreateStroke(keybindButton, Colors.Border, 1)
    
    -- Enable label (middle)
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 55, 0, 0),
        Size = UDim2.new(1, -130, 1, 0),
        Font = Enum.Font.Gotham,
        Text = "Enable " .. name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
    })
    
    -- Mode button (right side)
    local modeButton = Utility.Create("TextButton", {
        Name = "ModeButton",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -68, 0.5, -10),
        Size = UDim2.new(0, 60, 0, 20),
        Font = Enum.Font.Gotham,
        Text = "[" .. mode .. "]",
        TextColor3 = Colors.TextDark,
        TextSize = 9,
        AutoButtonColor = false,
    })
    
    local modeStroke = Utility.CreateStroke(modeButton, Colors.Border, 1)
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(keybindButton, {BackgroundColor3 = "Dropdown", TextColor3 = "Accent"})
    self.Tab.Library:RegisterThemeObject(keybindStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(modeButton, {BackgroundColor3 = "Dropdown", TextColor3 = "TextDark"})
    self.Tab.Library:RegisterThemeObject(modeStroke, {Color = "Border"})
    
    local function getKeyDisplayName()
        if currentKey == Enum.KeyCode.Unknown or currentKey == Enum.KeyCode.Backspace then
            return "None"
        end
        return currentKey.Name
    end
    
    local function updateWidget()
        if showWidget then
            if currentKey == Enum.KeyCode.Unknown or currentKey == Enum.KeyCode.Backspace then
                if self.Tab.Library.KeybindWidgetEntries[name] then
                    self.Tab.Library:RemoveKeybindFromWidget(name)
                end
            else
                if not self.Tab.Library.KeybindWidgetEntries[name] then
                    self.Tab.Library:AddKeybindToWidget(name, currentKey, mode)
                else
                    self.Tab.Library:UpdateKeybindInWidget(name, currentKey, mode)
                end
            end
        end
        
        if mode == "Always" then
            isActive = true
            self.Tab.Library:SetKeybindState(name, true)
            callback(true)
        end
    end
    
    -- Initialize widget
    if showWidget and currentKey ~= Enum.KeyCode.Unknown and currentKey ~= Enum.KeyCode.Backspace then
        self.Tab.Library:AddKeybindToWidget(name, currentKey, mode)
        if mode == "Always" then self.Tab.Library:SetKeybindState(name, true) end
    end
    
    -- Keybind button click - listen for key
    keybindButton.MouseButton1Click:Connect(function()
        listening = true
        keybindButton.Text = "..."
        Utility.Tween(keybindStroke, {Color = Colors.Accent}, 0.15)
    end)
    
    -- Mode button click - cycle through modes
    modeButton.MouseButton1Click:Connect(function()
        modeIndex = modeIndex % #modes + 1
        mode = modes[modeIndex]
        modeButton.Text = "[" .. mode .. "]"
        
        -- Reset state when changing mode
        if mode == "Always" then
            isActive = true
            self.Tab.Library:SetKeybindState(name, true)
            callback(true)
        else
            isActive = false
            self.Tab.Library:SetKeybindState(name, false)
            callback(false)
        end
        
        updateWidget()
    end)
    
    keybindButton.MouseEnter:Connect(function()
        if not listening then Utility.Tween(keybindStroke, {Color = Colors.AccentLight}, 0.15) end
    end)
    
    keybindButton.MouseLeave:Connect(function()
        if not listening then Utility.Tween(keybindStroke, {Color = Colors.Border}, 0.15) end
    end)
    
    modeButton.MouseEnter:Connect(function()
        Utility.Tween(modeStroke, {Color = Colors.AccentLight}, 0.15)
        Utility.Tween(modeButton, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    modeButton.MouseLeave:Connect(function()
        Utility.Tween(modeStroke, {Color = Colors.Border}, 0.15)
        Utility.Tween(modeButton, {TextColor3 = Colors.TextDark}, 0.15)
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    -- Key input handling
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if listening then
            if input.UserInputType == Enum.UserInputType.Keyboard then
                if input.KeyCode == Enum.KeyCode.Backspace then
                    currentKey = Enum.KeyCode.Unknown
                else
                    currentKey = input.KeyCode
                end
                
                keybindButton.Text = getKeyDisplayName()
                listening = false
                Utility.Tween(keybindStroke, {Color = Colors.Border}, 0.15)
                
                updateWidget()
                
                if flag then self.Tab.Library.Flags[flag] = currentKey end
            end
        elseif not gameProcessed and currentKey ~= Enum.KeyCode.Unknown and input.KeyCode == currentKey then
            if mode == "Toggle" then
                isActive = not isActive
                self.Tab.Library:SetKeybindState(name, isActive)
                callback(isActive)
            elseif mode == "Hold" then
                isActive = true
                self.Tab.Library:SetKeybindState(name, true)
                callback(true)
            end
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if not listening and currentKey ~= Enum.KeyCode.Unknown and input.KeyCode == currentKey then
            if mode == "Hold" then
                isActive = false
                self.Tab.Library:SetKeybindState(name, false)
                callback(false)
            end
        end
    end)
    
    if flag then self.Tab.Library.Flags[flag] = currentKey end
    
    if mode == "Always" then
        isActive = true
        callback(true)
    end
    
    return {
        Set = function(self, key)
            if key == Enum.KeyCode.Backspace then key = Enum.KeyCode.Unknown end
            currentKey = key
            keybindButton.Text = getKeyDisplayName()
            updateWidget()
        end,
        Get = function() return currentKey end,
        GetState = function() return isActive end,
        SetMode = function(self, newMode)
            local idx = table.find(modes, newMode)
            if idx then
                modeIndex = idx
                mode = newMode
                modeButton.Text = "[" .. mode .. "]"
                updateWidget()
            end
        end,
        GetMode = function() return mode end
    }
end

-- NEW: Complete Color Picker Rewrite with Hex/RGB inputs and Transparency
function Section:AddColorPicker(config)
    config = config or {}
    local name = config.Name or "Color Picker"
    local default = config.Default or Color3.fromRGB(139, 90, 43)
    local callback = config.Callback or function() end
    local flag = config.Flag
    local transparency = config.Transparency or false
    
    local currentColor = default
    local currentTransparency = 0
    local opened = false
    
    -- HSV values
    local h, s, v = currentColor:ToHSV()
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 28),
        ClipsDescendants = false,
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(1, -45, 0, 28),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    -- Color display button
    local colorButton = Utility.Create("TextButton", {
        Name = "ColorButton",
        Parent = container,
        BackgroundColor3 = currentColor,
        BackgroundTransparency = currentTransparency,
        BorderSizePixel = 0,
        Position = UDim2.new(1, -35, 0, 6),
        Size = UDim2.new(0, 27, 0, 16),
        Text = "",
        AutoButtonColor = false,
    })
    
    local colorButtonStroke = Utility.CreateStroke(colorButton, Utility.GetDarkerColor(currentColor), 1)
    
    -- Picker frame (popup)
    local pickerFrame = Utility.Create("Frame", {
        Name = "PickerFrame",
        Parent = self.Tab.Library.ScreenGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(colorButton.AbsolutePosition.X, colorButton.AbsolutePosition.Y + 20),
        Size = UDim2.fromOffset(230, transparency and 280 or 260),
        Visible = false,
        ZIndex = 100,
    })
    
    local pickerStroke = Utility.CreateStroke(pickerFrame, Colors.Accent, 1)
    Utility.CreateGlow(pickerFrame, Colors.AccentGlow, 30, Colors.GlowTransparency)
    
    -- Update picker position when color button moves
    colorButton:GetPropertyChangedSignal("AbsolutePosition"):Connect(function()
        pickerFrame.Position = UDim2.fromOffset(colorButton.AbsolutePosition.X - 195, colorButton.AbsolutePosition.Y + 20)
    end)
    
    -- Accent line at top
    Utility.Create("Frame", {
        Parent = pickerFrame,
        BackgroundColor3 = Colors.Accent,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 2),
        ZIndex = 101,
    })
    
    -- Title
    Utility.Create("TextLabel", {
        Parent = pickerFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 6),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.GothamBold,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 101,
    })
    
    -- Saturation/Value map (200x200)
    local satVibMap = Utility.Create("ImageLabel", {
        Name = "SatVibMap",
        Parent = pickerFrame,
        BackgroundColor3 = Color3.fromHSV(h, 1, 1),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 6, 0, 28),
        Size = UDim2.new(0, 180, 0, 180),
        Image = "rbxassetid://4155801252", -- Saturation gradient
        ZIndex = 101,
    })
    
    Utility.CreateStroke(satVibMap, Colors.Border, 1)
    
    -- Cursor for sat/vib map
    local satVibCursor = Utility.Create("Frame", {
        Name = "Cursor",
        Parent = satVibMap,
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        Size = UDim2.new(0, 8, 0, 8),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(s, 0, 1 - v, 0),
        ZIndex = 102,
    })
    
    Utility.Create("UICorner", {Parent = satVibCursor, CornerRadius = UDim.new(1, 0)})
    Utility.CreateStroke(satVibCursor, Color3.new(0, 0, 0), 1)
    
    -- Hue selector (vertical bar)
    local hueSelector = Utility.Create("Frame", {
        Name = "HueSelector",
        Parent = pickerFrame,
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 192, 0, 28),
        Size = UDim2.new(0, 30, 0, 180),
        ZIndex = 101,
    })
    
    Utility.CreateStroke(hueSelector, Colors.Border, 1)
    
    -- Hue gradient
    local hueGradient = Utility.Create("UIGradient", {
        Parent = hueSelector,
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
            ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 255, 0)),
            ColorSequenceKeypoint.new(0.33, Color3.fromRGB(0, 255, 0)),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 255)),
            ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
            ColorSequenceKeypoint.new(0.83, Color3.fromRGB(255, 0, 255)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0))
        }),
        Rotation = 90,
    })
    
    -- Hue cursor
    local hueCursor = Utility.Create("Frame", {
        Name = "HueCursor",
        Parent = hueSelector,
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 4, 0, 3),
        Position = UDim2.new(0, -2, h, 0),
        AnchorPoint = Vector2.new(0, 0.5),
        ZIndex = 102,
    })
    
    Utility.CreateStroke(hueCursor, Color3.new(0, 0, 0), 1)
    
    -- Hex input
    local hexBoxOuter = Utility.Create("Frame", {
        Parent = pickerFrame,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(6, 214),
        Size = UDim2.new(0, 107, 0, 22),
        ZIndex = 101,
    })
    
    Utility.CreateStroke(hexBoxOuter, Colors.Border, 1)
    
    local hexBox = Utility.Create("TextBox", {
        Parent = hexBoxOuter,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 6, 0, 0),
        Size = UDim2.new(1, -12, 1, 0),
        Font = Enum.Font.Gotham,
        PlaceholderText = "Hex",
        PlaceholderColor3 = Colors.TextDisabled,
        Text = "#" .. currentColor:ToHex():upper(),
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        ZIndex = 102,
    })
    
    -- RGB input
    local rgbBoxOuter = Utility.Create("Frame", {
        Parent = pickerFrame,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(117, 214),
        Size = UDim2.new(0, 107, 0, 22),
        ZIndex = 101,
    })
    
    Utility.CreateStroke(rgbBoxOuter, Colors.Border, 1)
    
    local rgbBox = Utility.Create("TextBox", {
        Parent = rgbBoxOuter,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 6, 0, 0),
        Size = UDim2.new(1, -12, 1, 0),
        Font = Enum.Font.Gotham,
        PlaceholderText = "RGB",
        PlaceholderColor3 = Colors.TextDisabled,
        Text = string.format("%d, %d, %d", math.floor(currentColor.R * 255), math.floor(currentColor.G * 255), math.floor(currentColor.B * 255)),
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        ZIndex = 102,
    })
    
    -- Transparency slider (optional)
    local transparencyBar, transparencyCursor
    if transparency then
        transparencyBar = Utility.Create("Frame", {
            Name = "TransparencyBar",
            Parent = pickerFrame,
            BackgroundColor3 = currentColor,
            BorderSizePixel = 0,
            Position = UDim2.fromOffset(6, 242),
            Size = UDim2.new(1, -12, 0, 15),
            ZIndex = 101,
        })
        
        Utility.CreateStroke(transparencyBar, Colors.Border, 1)
        
        -- Checker pattern for transparency
        Utility.Create("ImageLabel", {
            Parent = transparencyBar,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Image = "rbxassetid://4802984321",
            ScaleType = Enum.ScaleType.Tile,
            TileSize = UDim2.new(0, 10, 0, 10),
            ZIndex = 101,
        })
        
        -- Gradient overlay for transparency
        local transpOverlay = Utility.Create("Frame", {
            Parent = transparencyBar,
            BackgroundColor3 = currentColor,
            Size = UDim2.new(1, 0, 1, 0),
            ZIndex = 102,
        })
        
        Utility.Create("UIGradient", {
            Parent = transpOverlay,
            Transparency = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 0),
                NumberSequenceKeypoint.new(1, 1)
            }),
        })
        
        transparencyCursor = Utility.Create("Frame", {
            Name = "TranspCursor",
            Parent = transparencyBar,
            BackgroundColor3 = Color3.new(1, 1, 1),
            BorderSizePixel = 0,
            Size = UDim2.new(0, 3, 1, 4),
            Position = UDim2.new(1 - currentTransparency, 0, 0, -2),
            AnchorPoint = Vector2.new(0.5, 0),
            ZIndex = 103,
        })
        
        Utility.CreateStroke(transparencyCursor, Color3.new(0, 0, 0), 1)
    end
    
    -- Context menu
    local contextMenu = Utility.Create("Frame", {
        Name = "ContextMenu",
        Parent = self.Tab.Library.ScreenGui,
        BackgroundColor3 = Colors.Background,
        BorderSizePixel = 0,
        Size = UDim2.new(0, 100, 0, 0),
        Visible = false,
        ZIndex = 150,
        ClipsDescendants = true,
    })
    
    Utility.CreateStroke(contextMenu, Colors.Accent, 1)
    
    Utility.Create("UIListLayout", {
        Parent = contextMenu,
        SortOrder = Enum.SortOrder.LayoutOrder,
    })
    
    local contextOptions = {"Copy color", "Paste color", "Copy HEX", "Copy RGB"}
    
    for i, optionText in ipairs(contextOptions) do
        local optBtn = Utility.Create("TextButton", {
            Parent = contextMenu,
            BackgroundColor3 = Colors.Background,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 0, 22),
            Font = Enum.Font.Gotham,
            Text = "  " .. optionText,
            TextColor3 = Colors.Text,
            TextSize = 11,
            TextXAlignment = Enum.TextXAlignment.Left,
            AutoButtonColor = false,
            ZIndex = 151,
        })
        
        optBtn.MouseEnter:Connect(function()
            Utility.Tween(optBtn, {TextColor3 = Colors.Accent}, 0.1)
        end)
        
        optBtn.MouseLeave:Connect(function()
            Utility.Tween(optBtn, {TextColor3 = Colors.Text}, 0.1)
        end)
        
        optBtn.MouseButton1Click:Connect(function()
            if optionText == "Copy color" then
                ColorClipboard = currentColor
                self.Tab.Library:Notify({Title = "Color Picker", Content = "Copied color!", Type = "Success", Duration = 2})
            elseif optionText == "Paste color" then
                if ColorClipboard then
                    h, s, v = ColorClipboard:ToHSV()
                    updateDisplay()
                    self.Tab.Library:Notify({Title = "Color Picker", Content = "Pasted color!", Type = "Success", Duration = 2})
                else
                    self.Tab.Library:Notify({Title = "Color Picker", Content = "No color copied!", Type = "Error", Duration = 2})
                end
            elseif optionText == "Copy HEX" then
                if setclipboard then
                    pcall(setclipboard, currentColor:ToHex())
                    self.Tab.Library:Notify({Title = "Color Picker", Content = "Copied HEX to clipboard!", Type = "Success", Duration = 2})
                end
            elseif optionText == "Copy RGB" then
                if setclipboard then
                    pcall(setclipboard, string.format("%d, %d, %d", math.floor(currentColor.R * 255), math.floor(currentColor.G * 255), math.floor(currentColor.B * 255)))
                    self.Tab.Library:Notify({Title = "Color Picker", Content = "Copied RGB to clipboard!", Type = "Success", Duration = 2})
                end
            end
            
            contextMenu.Visible = false
        end)
    end
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(pickerFrame, {BackgroundColor3 = "Background"})
    self.Tab.Library:RegisterThemeObject(pickerStroke, {Color = "Accent"})
    self.Tab.Library:RegisterThemeObject(hexBoxOuter, {BackgroundColor3 = "Dropdown"})
    self.Tab.Library:RegisterThemeObject(rgbBoxOuter, {BackgroundColor3 = "Dropdown"})
    self.Tab.Library:RegisterThemeObject(hexBox, {TextColor3 = "Text", PlaceholderColor3 = "TextDisabled"})
    self.Tab.Library:RegisterThemeObject(rgbBox, {TextColor3 = "Text", PlaceholderColor3 = "TextDisabled"})
    self.Tab.Library:RegisterThemeObject(contextMenu, {BackgroundColor3 = "Background"})
    
    local function updateDisplay()
        currentColor = Color3.fromHSV(h, s, v)
        
        satVibMap.BackgroundColor3 = Color3.fromHSV(h, 1, 1)
        satVibCursor.Position = UDim2.new(s, 0, 1 - v, 0)
        hueCursor.Position = UDim2.new(0, -2, h, 0)
        
        colorButton.BackgroundColor3 = currentColor
        colorButton.BackgroundTransparency = currentTransparency
        colorButtonStroke.Color = Utility.GetDarkerColor(currentColor)
        
        hexBox.Text = "#" .. currentColor:ToHex():upper()
        rgbBox.Text = string.format("%d, %d, %d", math.floor(currentColor.R * 255), math.floor(currentColor.G * 255), math.floor(currentColor.B * 255))
        
        if transparencyBar then
            transparencyBar.BackgroundColor3 = currentColor
            transparencyCursor.Position = UDim2.new(1 - currentTransparency, 0, 0, -2)
        end
        
        callback(currentColor, currentTransparency)
        
        if flag then
            self.Tab.Library.Flags[flag] = currentColor
            if transparency then
                self.Tab.Library.Flags[flag .. "_transparency"] = currentTransparency
            end
        end
    end
    
    -- Sat/Vib map dragging
    local satVibDragging = false
    
    satVibMap.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            satVibDragging = true
        end
    end)
    
    satVibMap.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            satVibDragging = false
        end
    end)
    
    -- Hue selector dragging
    local hueDragging = false
    
    hueSelector.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            hueDragging = true
        end
    end)
    
    hueSelector.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            hueDragging = false
        end
    end)
    
    -- Transparency dragging
    local transpDragging = false
    
    if transparencyBar then
        transparencyBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                transpDragging = true
            end
        end)
        
        transparencyBar.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                transpDragging = false
            end
        end)
    end
    
    -- Mouse movement handling
    RunService.RenderStepped:Connect(function()
        if satVibDragging then
            local mousePos = UserInputService:GetMouseLocation()
            local relX = math.clamp((mousePos.X - satVibMap.AbsolutePosition.X) / satVibMap.AbsoluteSize.X, 0, 1)
            local relY = math.clamp((mousePos.Y - satVibMap.AbsolutePosition.Y) / satVibMap.AbsoluteSize.Y, 0, 1)
            
            s = relX
            v = 1 - relY
            updateDisplay()
        end
        
        if hueDragging then
            local mousePos = UserInputService:GetMouseLocation()
            local relY = math.clamp((mousePos.Y - hueSelector.AbsolutePosition.Y) / hueSelector.AbsoluteSize.Y, 0, 1)
            
            h = relY
            updateDisplay()
        end
        
        if transpDragging and transparencyBar then
            local mousePos = UserInputService:GetMouseLocation()
            local relX = math.clamp((mousePos.X - transparencyBar.AbsolutePosition.X) / transparencyBar.AbsoluteSize.X, 0, 1)
            
            currentTransparency = 1 - relX
            updateDisplay()
        end
    end)
    
    -- Hex input
    hexBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local success, result = pcall(Color3.fromHex, hexBox.Text:gsub("#", ""))
            if success and typeof(result) == "Color3" then
                h, s, v = result:ToHSV()
                updateDisplay()
            end
        end
        hexBox.Text = "#" .. currentColor:ToHex():upper()
    end)
    
    -- RGB input
    rgbBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local r, g, b = rgbBox.Text:match("(%d+)%s*,%s*(%d+)%s*,%s*(%d+)")
            if r and g and b then
                r, g, b = tonumber(r), tonumber(g), tonumber(b)
                if r and g and b then
                    r = math.clamp(r, 0, 255)
                    g = math.clamp(g, 0, 255)
                    b = math.clamp(b, 0, 255)
                    h, s, v = Color3.fromRGB(r, g, b):ToHSV()
                    updateDisplay()
                end
            end
        end
        rgbBox.Text = string.format("%d, %d, %d", math.floor(currentColor.R * 255), math.floor(currentColor.G * 255), math.floor(currentColor.B * 255))
    end)
    
    -- Toggle picker visibility
    colorButton.MouseButton1Click:Connect(function()
        if opened then
            pickerFrame.Visible = false
            self.Tab.Library.OpenedFrames[pickerFrame] = nil
            opened = false
        else
            -- Close other pickers
            for frame, _ in pairs(self.Tab.Library.OpenedFrames) do
                if frame.Name == "PickerFrame" then
                    frame.Visible = false
                    self.Tab.Library.OpenedFrames[frame] = nil
                end
            end
            
            contextMenu.Visible = false
            pickerFrame.Position = UDim2.fromOffset(colorButton.AbsolutePosition.X - 195, colorButton.AbsolutePosition.Y + 20)
            pickerFrame.Visible = true
            self.Tab.Library.OpenedFrames[pickerFrame] = true
            opened = true
        end
    end)
    
    -- Right click for context menu
    colorButton.MouseButton2Click:Connect(function()
        contextMenu.Position = UDim2.fromOffset(colorButton.AbsolutePosition.X + colorButton.AbsoluteSize.X + 4, colorButton.AbsolutePosition.Y)
        contextMenu.Size = UDim2.new(0, 100, 0, #contextOptions * 22)
        contextMenu.Visible = true
        pickerFrame.Visible = false
        self.Tab.Library.OpenedFrames[pickerFrame] = nil
        opened = false
    end)
    
    -- Close context menu when clicking outside
    UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if contextMenu.Visible and not Utility.MouseIsOverFrame(contextMenu) and not Utility.MouseIsOverFrame(colorButton) then
                contextMenu.Visible = false
            end
        end
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        self.Tab.Library.Flags[flag] = currentColor
        if transparency then
            self.Tab.Library.Flags[flag .. "_transparency"] = currentTransparency
        end
        
        self.Tab.Library.FlagCallbacks[flag] = function(color)
            h, s, v = color:ToHSV()
            updateDisplay()
        end
    end
    
    updateDisplay()
    
    return {
        Set = function(self, color, transp)
            h, s, v = color:ToHSV()
            if transp then currentTransparency = transp end
            updateDisplay()
        end,
        SetValueRGB = function(self, color, transp)
            h, s, v = color:ToHSV()
            if transp then currentTransparency = transp end
            updateDisplay()
        end,
        Get = function()
            return currentColor, currentTransparency
        end
    }
end

function Section:AddLabel(config)
    config = config or {}
    local text = config.Text or "Label"
    
    local label = Utility.Create("TextLabel", {
        Name = "Label",
        Parent = self.Content,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 16),
        Font = Enum.Font.Gotham,
        Text = text,
        TextColor3 = Colors.TextDark,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "TextDark"})
    
    return {
        Set = function(self, newText)
            label.Text = newText
        end
    }
end

function Section:AddTextBox(config)
    config = config or {}
    local name = config.Name or "TextBox"
    local default = config.Default or ""
    local placeholder = config.Placeholder or "Enter text..."
    local callback = config.Callback or function() end
    local flag = config.Flag
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50),
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local textBox = Utility.Create("TextBox", {
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 22),
        Size = UDim2.new(1, -16, 0, 22),
        Font = Enum.Font.Gotham,
        PlaceholderText = placeholder,
        PlaceholderColor3 = Colors.TextDisabled,
        Text = default,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
    })
    
    Utility.Create("UIPadding", {
        Parent = textBox,
        PaddingLeft = UDim.new(0, 6),
        PaddingRight = UDim.new(0, 6),
    })
    
    local textBoxStroke = Utility.CreateStroke(textBox, Colors.Border, 1)
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(textBox, {BackgroundColor3 = "Dropdown", TextColor3 = "Text", PlaceholderColor3 = "TextDisabled"})
    self.Tab.Library:RegisterThemeObject(textBoxStroke, {Color = "Border"})
    
    textBox.Focused:Connect(function()
        Utility.Tween(textBoxStroke, {Color = Colors.Accent}, 0.15)
    end)
    
    textBox.FocusLost:Connect(function()
        Utility.Tween(textBoxStroke, {Color = Colors.Border}, 0.15)
        callback(textBox.Text)
        if flag then self.Tab.Library.Flags[flag] = textBox.Text end
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    if flag then
        self.Tab.Library.Flags[flag] = default
        self.Tab.Library.FlagCallbacks[flag] = function(value)
            textBox.Text = value
        end
    end
    
    return {
        Set = function(self, text)
            textBox.Text = text
            callback(text)
        end,
        Get = function()
            return textBox.Text
        end
    }
end

function Section:AddParagraph(config)
    config = config or {}
    local title = config.Title or "Paragraph"
    local content = config.Content or ""
    
    local container = Utility.Create("Frame", {
        Name = title,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local titleLabel = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 4),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.GothamBold,
        Text = title,
        TextColor3 = Colors.Accent,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local contentLabel = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 22),
        Size = UDim2.new(1, -16, 0, 0),
        Font = Enum.Font.Gotham,
        Text = content,
        TextColor3 = Colors.TextDark,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Top,
        TextWrapped = true,
        AutomaticSize = Enum.AutomaticSize.Y,
    })
    
    Utility.Create("UIPadding", {
        Parent = container,
        PaddingBottom = UDim.new(0, 8),
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(titleLabel, {TextColor3 = "Accent"})
    self.Tab.Library:RegisterThemeObject(contentLabel, {TextColor3 = "TextDark"})
    
    return {
        SetTitle = function(self, newTitle)
            titleLabel.Text = newTitle
        end,
        SetContent = function(self, newContent)
            contentLabel.Text = newContent
        end
    }
end

function Section:AddDivider()
    local divider = Utility.Create("Frame", {
        Name = "Divider",
        Parent = self.Content,
        BackgroundColor3 = Colors.Border,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 1),
    })
    
    self.Tab.Library:RegisterThemeObject(divider, {BackgroundColor3 = "Border"})
    
    return divider
end

-- Player List element
function Section:AddPlayerList(config)
    config = config or {}
    local name = config.Name or "Player List"
    local callback = config.Callback or function() end
    local flag = config.Flag
    local multiSelect = config.MultiSelect or false
    
    local selected = multiSelect and {} or nil
    local opened = false
    
    local container = Utility.Create("Frame", {
        Name = name,
        Parent = self.Content,
        BackgroundColor3 = Colors.BackgroundLight,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 50),
        ClipsDescendants = true,
    })
    
    local containerStroke = Utility.CreateStroke(container, Colors.Border, 1)
    
    local label = Utility.Create("TextLabel", {
        Parent = container,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 2),
        Size = UDim2.new(1, -16, 0, 16),
        Font = Enum.Font.Gotham,
        Text = name,
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    
    local function getDisplayText()
        if multiSelect then
            local count = 0
            for _ in pairs(selected) do count = count + 1 end
            if count == 0 then return "None selected"
            elseif count == 1 then
                for name in pairs(selected) do return name end
            else
                return count .. " selected"
            end
        else
            return selected or "Select player..."
        end
    end
    
    local dropdownButton = Utility.Create("TextButton", {
        Name = "DropdownButton",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 20),
        Size = UDim2.new(1, -16, 0, 24),
        Font = Enum.Font.Gotham,
        Text = "  " .. getDisplayText(),
        TextColor3 = Colors.Text,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        AutoButtonColor = false,
    })
    
    local dropdownStroke = Utility.CreateStroke(dropdownButton, Colors.Border, 1)
    
    local arrow = Utility.Create("TextLabel", {
        Parent = dropdownButton,
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -20, 0, 0),
        Size = UDim2.new(0, 20, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "v",
        TextColor3 = Colors.TextDark,
        TextSize = 8,
    })
    
    local optionContainer = Utility.Create("ScrollingFrame", {
        Name = "Options",
        Parent = container,
        BackgroundColor3 = Colors.Dropdown,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 8, 0, 46),
        Size = UDim2.new(1, -16, 0, 0),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 2,
        ScrollBarImageColor3 = Colors.Accent,
        ClipsDescendants = true,
    })
    
    local optionContainerStroke = Utility.CreateStroke(optionContainer, Colors.Border, 1)
    
    Utility.Create("UIListLayout", {
        Parent = optionContainer,
        SortOrder = Enum.SortOrder.Name,
    })
    
    self.Tab.Library:RegisterThemeObject(container, {BackgroundColor3 = "BackgroundLight"})
    self.Tab.Library:RegisterThemeObject(containerStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(label, {TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownButton, {BackgroundColor3 = "Dropdown", TextColor3 = "Text"})
    self.Tab.Library:RegisterThemeObject(dropdownStroke, {Color = "Border"})
    self.Tab.Library:RegisterThemeObject(arrow, {TextColor3 = "TextDark"})
    self.Tab.Library:RegisterThemeObject(optionContainer, {BackgroundColor3 = "Dropdown"})
    self.Tab.Library:RegisterThemeObject(optionContainerStroke, {Color = "Border"})
    
    local function refreshPlayers()
        for _, child in pairs(optionContainer:GetChildren()) do
            if child:IsA("TextButton") or child:IsA("Frame") then
                child:Destroy()
            end
        end
        
        local players = Players:GetPlayers()
        
        for _, player in pairs(players) do
            if player ~= Player then
                if multiSelect then
                    local optionFrame = Utility.Create("Frame", {
                        Name = player.Name,
                        Parent = optionContainer,
                        BackgroundColor3 = Colors.Dropdown,
                        BorderSizePixel = 0,
                        Size = UDim2.new(1, 0, 0, 24),
                    })
                    
                    local checkbox = Utility.Create("Frame", {
                        Parent = optionFrame,
                        BackgroundColor3 = selected[player.Name] and Colors.Toggle or Colors.ToggleOff,
                        BorderSizePixel = 0,
                        Position = UDim2.new(0, 6, 0.5, -6),
                        Size = UDim2.new(0, 12, 0, 12),
                    })
                    
                    Utility.CreateStroke(checkbox, Colors.Border, 1)
                    
                    local checkmark = Utility.Create("TextLabel", {
                        Parent = checkbox,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, 0, 1, 0),
                        Font = Enum.Font.GothamBold,
                        Text = selected[player.Name] and "+" or "",
                        TextColor3 = Colors.PastelCream,
                        TextSize = 10,
                    })
                    
                    local playerLabel = Utility.Create("TextLabel", {
                        Parent = optionFrame,
                        BackgroundTransparency = 1,
                        Position = UDim2.new(0, 24, 0, 0),
                        Size = UDim2.new(1, -30, 1, 0),
                        Font = Enum.Font.Gotham,
                        Text = player.Name,
                        TextColor3 = Colors.Text,
                        TextSize = 11,
                        TextXAlignment = Enum.TextXAlignment.Left,
                    })
                    
                    local clickButton = Utility.Create("TextButton", {
                        Parent = optionFrame,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, 0, 1, 0),
                        Text = "",
                    })
                    
                    clickButton.MouseEnter:Connect(function()
                        Utility.Tween(optionFrame, {BackgroundColor3 = Colors.Accent}, 0.1)
                    end)
                    
                    clickButton.MouseLeave:Connect(function()
                        Utility.Tween(optionFrame, {BackgroundColor3 = Colors.Dropdown}, 0.1)
                    end)
                    
                    clickButton.MouseButton1Click:Connect(function()
                        selected[player.Name] = not selected[player.Name]
                        checkbox.BackgroundColor3 = selected[player.Name] and Colors.Toggle or Colors.ToggleOff
                        checkmark.Text = selected[player.Name] and "+" or ""
                        dropdownButton.Text = "  " .. getDisplayText()
                        
                        local selectedPlayers = {}
                        for name, isSelected in pairs(selected) do
                            if isSelected then
                                local plr = Players:FindFirstChild(name)
                                if plr then table.insert(selectedPlayers, plr) end
                            end
                        end
                        callback(selectedPlayers)
                        if flag then self.Tab.Library.Flags[flag] = selectedPlayers end
                    end)
                else
                    local optionButton = Utility.Create("TextButton", {
                        Name = player.Name,
                        Parent = optionContainer,
                        BackgroundColor3 = Colors.Dropdown,
                        BorderSizePixel = 0,
                        Size = UDim2.new(1, 0, 0, 24),
                        Font = Enum.Font.Gotham,
                        Text = "  " .. player.Name,
                        TextColor3 = player.Name == selected and Colors.Accent or Colors.Text,
                        TextSize = 11,
                        TextXAlignment = Enum.TextXAlignment.Left,
                        AutoButtonColor = false,
                    })
                    
                    optionButton.MouseEnter:Connect(function()
                        Utility.Tween(optionButton, {BackgroundColor3 = Colors.Accent, TextColor3 = Colors.PastelCream}, 0.1)
                    end)
                    
                    optionButton.MouseLeave:Connect(function()
                        Utility.Tween(optionButton, {BackgroundColor3 = Colors.Dropdown, TextColor3 = player.Name == selected and Colors.Accent or Colors.Text}, 0.1)
                    end)
                    
                    optionButton.MouseButton1Click:Connect(function()
                        selected = player.Name
                        dropdownButton.Text = "  " .. getDisplayText()
                        
                        for _, btn in pairs(optionContainer:GetChildren()) do
                            if btn:IsA("TextButton") then
                                btn.TextColor3 = btn.Name == selected and Colors.Accent or Colors.Text
                            end
                        end
                        
                        callback(player)
                        if flag then self.Tab.Library.Flags[flag] = player end
                        
                        opened = false
                        Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50)}, 0.2)
                        Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, 0)}, 0.2)
                        Utility.Tween(arrow, {Rotation = 0}, 0.2)
                    end)
                end
            end
        end
        
        local playerCount = #players - 1
        optionContainer.CanvasSize = UDim2.new(0, 0, 0, playerCount * 24)
    end
    
    refreshPlayers()
    
    Players.PlayerAdded:Connect(refreshPlayers)
    Players.PlayerRemoving:Connect(function(player)
        if multiSelect then
            selected[player.Name] = nil
        elseif selected == player.Name then
            selected = nil
        end
        refreshPlayers()
        dropdownButton.Text = "  " .. getDisplayText()
    end)
    
    local function toggleDropdown()
        opened = not opened
        refreshPlayers()
        
        local playerCount = #Players:GetPlayers() - 1
        local optionHeight = math.min(playerCount * 24, 120)
        
        if opened then
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50 + optionHeight + 4)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, optionHeight)}, 0.2)
            Utility.Tween(arrow, {Rotation = 180}, 0.2)
        else
            Utility.Tween(container, {Size = UDim2.new(1, 0, 0, 50)}, 0.2)
            Utility.Tween(optionContainer, {Size = UDim2.new(1, -16, 0, 0)}, 0.2)
            Utility.Tween(arrow, {Rotation = 0}, 0.2)
        end
    end
    
    dropdownButton.MouseButton1Click:Connect(toggleDropdown)
    
    dropdownButton.MouseEnter:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Accent}, 0.15)
    end)
    
    dropdownButton.MouseLeave:Connect(function()
        Utility.Tween(dropdownStroke, {Color = Colors.Border}, 0.15)
    end)
    
    container.MouseEnter:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Accent}, 0.15)
    end)
    
    container.MouseLeave:Connect(function()
        Utility.Tween(label, {TextColor3 = Colors.Text}, 0.15)
    end)
    
    return {
        Refresh = refreshPlayers,
        GetSelected = function()
            if multiSelect then
                local result = {}
                for name, isSelected in pairs(selected) do
                    if isSelected then
                        local plr = Players:FindFirstChild(name)
                        if plr then table.insert(result, plr) end
                    end
                end
                return result
            else
                return selected and Players:FindFirstChild(selected)
            end
        end
    }
end

function MilkChocolate:GetThemes()
    local themeNames = {}
    for name, _ in pairs(Themes) do
        table.insert(themeNames, name)
    end
    return themeNames
end

function MilkChocolate:AddTheme(name, themeData)
    Themes[name] = themeData
end

-- Unload function
function MilkChocolate:Unload()
    -- Close all connections
    for _, connection in pairs(self.Connections or {}) do
        if connection then
            connection:Disconnect()
        end
    end
    
    -- Destroy GUI
    if self.ScreenGui then
        self.ScreenGui:Destroy()
    end
    
    -- Clear data
    self.Tabs = {}
    self.Flags = {}
    self.FlagCallbacks = {}
    self.ThemeObjects = {}
    self.KeybindWidgetEntries = {}
    self.KeybindStates = {}
    self.OpenedFrames = {}
end

return MilkChocolate
